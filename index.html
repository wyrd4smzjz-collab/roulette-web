<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magik Spin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: #050505; color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

```
    /* â”€â”€â”€â”€â”€ MAIN SCREEN â”€â”€â”€â”€â”€ */
    #main-screen {
        width: 100%;
        min-height: 100dvh;
        display: flex; flex-direction: column;
        align-items: center; justify-content: space-between;
        padding: calc(env(safe-area-inset-top) + 8px) 0
                 calc(env(safe-area-inset-bottom) + 8px) 0;
        gap: 4px;
    }

    /* â”€â”€â”€â”€â”€ TOP BAR â”€â”€â”€â”€â”€ */
    .top-bar {
        width: 100%; padding: 2px 12px;
        display: flex; justify-content: center; align-items: center;
        position: relative; flex-shrink: 0;
    }
    .bal-display {
        font-size: clamp(1.4em, 6vw, 2em);
        font-weight: bold; color: gold;
        text-shadow: 0 0 15px rgba(255,215,0,0.6);
    }
    .wallet-btn {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        background: rgba(142,68,173,0.3); border: 1px solid #8e44ad;
        color: white; border-radius: 8px;
        padding: 5px 10px; font-size: 0.78em; cursor: pointer;
    }

    /* â”€â”€â”€â”€â”€ SUPERBONUS BANNER â”€â”€â”€â”€â”€ */
    #sb-banner {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 8px);
        left: 10px;
        z-index: 50;
        background: linear-gradient(135deg,#1a0f00,#2d1a00,#1a0f00);
        border: 1.5px solid #ffd700; border-radius: 10px;
        padding: 4px 10px 4px 7px;
        display: flex; align-items: center; gap: 5px;
        box-shadow: 0 0 8px #ffd700, 0 0 20px #ffaa00;
        animation: sbPulse 2.2s ease-in-out infinite;
        pointer-events: none;
    }
    @keyframes sbPulse {
        0%,100%{box-shadow:0 0 8px #ffd700,0 0 20px #ffaa00,0 0 35px rgba(255,136,0,.4)}
        50%    {box-shadow:0 0 16px #ffd700,0 0 36px #ffaa00,0 0 65px rgba(255,136,0,.7)}
    }
    .sb-crown  { font-size: 18px; filter: drop-shadow(0 0 6px #ffd700); }
    .sb-text   { display: flex; flex-direction: column; line-height: 1.2; }
    .sb-label  { font-size: 7px; font-weight: 900; letter-spacing: 2px; color: #ffd700; text-transform: uppercase; }
    .sb-amount { font-size: 13px; font-weight: 900; color: #fff; text-shadow: 0 0 8px #ffd700; }

    /* â”€â”€â”€â”€â”€ WHEEL â”€â”€â”€â”€â”€ */
    .wheel-wrap {
        position: relative;
        width: min(80vw, 300px);
        aspect-ratio: 1/1;
        flex-shrink: 0;
    }
    canvas { width: 100%; height: 100%; filter: drop-shadow(0 0 12px #8e44ad); display: block; }

    /* Pointer â€” animated triangle */
    #ptr {
        position: absolute;
        top: -12px; left: 50%;
        transform: translateX(-50%) rotate(0deg);
        transform-origin: 50% 100%;  /* pivot at tip base */
        width: 0; height: 0;
        border-left: 13px solid transparent;
        border-right: 13px solid transparent;
        border-top: 24px solid #f1c40f;
        z-index: 10;
        filter: drop-shadow(0 0 7px rgba(241,196,15,.9));
        will-change: transform;
    }

    /* â”€â”€â”€â”€â”€ HISTORY â”€â”€â”€â”€â”€ */
    #history-bar {
        width: 92%; max-width: 320px;
        display: flex; gap: 5px; overflow-x: auto;
        padding: 2px 0; scrollbar-width: none; flex-shrink: 0;
    }
    #history-bar::-webkit-scrollbar { display: none; }
    .h-chip {
        flex-shrink: 0; border-radius: 20px; padding: 3px 9px;
        font-size: 0.7em; font-weight: bold; white-space: nowrap;
        opacity: 0; transform: scale(.5);
        animation: chipIn .3s forwards;
    }
    @keyframes chipIn { to { opacity:1; transform:scale(1); } }
    .h-win  { background:rgba(39,174,96,.22);  border:1px solid #27ae60; color:#2ecc71; }
    .h-lose { background:rgba(231,76,60,.22);   border:1px solid #e74c3c; color:#e74c3c; }
    .h-free { background:rgba(52,152,219,.22);  border:1px solid #3498db; color:#74b9ff; }

    /* â”€â”€â”€â”€â”€ CONTROLS â”€â”€â”€â”€â”€ */
    .controls {
        width: 92%; max-width: 360px;
        display: flex; flex-direction: column; align-items: center;
        gap: 8px; flex-shrink: 0;
    }
    .bet-row {
        display: flex; align-items: center; justify-content: center; gap: 10px;
        width: 100%;
    }
    #sound-btn {
        background: rgba(142,68,173,.3); border: 1px solid #8e44ad;
        color: white; border-radius: 50%;
        width: 40px; height: 40px; font-size: 18px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0;
    }
    .btn-adj {
        background: #8e44ad; border: none; color: white;
        width: 44px; height: 44px; border-radius: 50%; font-size: 1.4em;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0;
    }
    .bet-label { font-size: 0.9em; text-align: center; line-height: 1.3; }
    .bet-label b { font-size: 1.15em; }
    .spin-btn {
        width: 100%; padding: 15px; border-radius: 50px; border: none;
        color: white; font-weight: bold;
        font-size: clamp(1.1em, 4.5vw, 1.4em);
        background: #8e44ad; box-shadow: 0 0 22px #8e44ad;
        transition: all .3s; cursor: pointer;
    }
    .dep-mode  { background:#e74c3c!important; box-shadow:0 0 22px #e74c3c!important; }
    .free-mode { background:#27ae60!important; box-shadow:0 0 22px #27ae60!important; }

    /* â”€â”€â”€â”€â”€ MODAL â”€â”€â”€â”€â”€ */
    #modal {
        display: none; position: fixed; inset: 0;
        background: #000; z-index: 100;
        flex-direction: column; overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    #modal.open { display: flex; }
    .tabs { display: flex; background: #1a1a1a; flex-shrink: 0; }
    .tab { flex:1; padding: 16px; text-align: center; font-weight: bold; cursor: pointer; font-size: .9em; }
    .tab.active { border-bottom: 3px solid #8e44ad; color: #8e44ad; }
    .tab-content {
        display: none; padding: 20px 18px 80px;
        flex-direction: column; align-items: center; width: 100%;
    }
    .tab-content.active { display: flex; }
    .m-title { margin-bottom: 4px; }
    .modal-input {
        width: 100%; padding: 14px; margin: 7px 0;
        border-radius: 12px; border: 1px solid #444;
        background: #111; color: white; font-size: 1em;
    }
    .modal-input:focus { outline: none; border-color: #8e44ad; }
    .hint  { color: #666; font-size: .78em; text-align: center; margin: 2px 0 6px; line-height: 1.4; }
    .warn  { color: #e74c3c; font-size: .82em; text-align: center; margin: 4px 0; }
    .preview { color: #0af; font-size: 1.05em; font-weight: bold; margin: 8px 0 2px; }
    .rate-lbl { color: #777; font-size: .75em; text-align: center; }
    .modal-btn {
        width: 100%; padding: 16px; border-radius: 50px; border: none;
        color: white; font-weight: bold; font-size: 1.2em;
        background: #8e44ad; box-shadow: 0 0 18px #8e44ad;
        margin-top: 12px; cursor: pointer;
    }
    .modal-btn.green { background:#27ae60; box-shadow:0 0 18px #27ae60; }
    .back-link { margin-top: 22px; color: #777; font-size: .9em; cursor: pointer; }
</style>
```

</head>
<body>

<!-- SuperBonus Banner -->

<div id="sb-banner">
    <span class="sb-crown">ğŸ‘‘</span>
    <div class="sb-text">
        <span class="sb-label">SuperBonus</span>
        <span class="sb-amount">500 TON</span>
    </div>
</div>

<!-- Main Screen -->

<div id="main-screen">
    <div class="top-bar">
        <div class="bal-display">â­ <span id="s_bal">0</span></div>
        <button class="wallet-btn" onclick="openM()">ĞšĞ¾ÑˆĞµĞ»ĞµĞº</button>
    </div>

```
<div class="wheel-wrap">
    <div id="ptr"></div>
    <canvas id="canvas" width="600" height="600"></canvas>
</div>

<div id="history-bar"></div>

<div class="controls">
    <div class="bet-row">
        <button id="sound-btn" onclick="toggleSound()">ğŸ”Š</button>
        <button class="btn-adj" onclick="adjBet(-5)">âˆ’</button>
        <div class="bet-label">Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°<br><b id="cur_bet">5</b> â­</div>
        <button class="btn-adj" onclick="adjBet(5)">+</button>
    </div>
    <button id="spinBtn" class="spin-btn" onclick="handleSpin()">ĞšĞ Ğ£Ğ¢Ğ˜Ğ¢Ğ¬</button>
</div>
```

</div>

<!-- Modal Wallet -->

<div id="modal">
    <div class="tabs">
        <div class="tab active" id="tab-dep" onclick="setTab('dep',this)">ĞŸĞĞŸĞĞ›ĞĞ˜Ğ¢Ğ¬</div>
        <div class="tab"        id="tab-wit" onclick="setTab('wit',this)">Ğ’Ğ«Ğ’ĞĞ”</div>
    </div>

```
<!-- DEPOSIT -->
<div id="dep" class="tab-content active">
    <h2 class="m-title" style="color:gold">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ â­</h2>
    <p class="warn">ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 10 â­</p>
    <input class="modal-input" type="number" id="dep_val"
           placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ²Ñ‘Ğ·Ğ´" min="10" inputmode="numeric">
    <p class="hint">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ²Ñ‘Ğ·Ğ´ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</p>
    <button class="modal-btn green" onclick="doDep()">ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬ â­</button>
    <p class="back-link" onclick="closeM()">â† ĞĞ°Ğ·Ğ°Ğ´</p>
</div>

<!-- WITHDRAW -->
<div id="wit" class="tab-content">
    <h2 class="m-title" style="color:#0088cc">Ğ’Ñ‹Ğ²Ğ¾Ğ´ TON</h2>
    <p class="warn">ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 500 â­</p>
    <input class="modal-input" type="number" id="w_stars"
           placeholder="Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ·Ğ²Ñ‘Ğ·Ğ´ (Ğ¼Ğ¸Ğ½. 500)" inputmode="numeric" oninput="calcWit()">
    <div class="preview" id="wit_preview">Ğ’Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ: â€” TON</div>
    <p class="rate-lbl" id="rate-label">ĞšÑƒÑ€Ñ: Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</p>
    <input class="modal-input" type="text" id="w_addr" placeholder="ĞĞ´Ñ€ĞµÑ TON (UQ...)">
    <input class="modal-input" type="text" id="w_memo" placeholder="MEMO / Tag">
    <p class="hint">MEMO â€” ĞµÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ±Ğ¸Ñ€Ğ¶ĞµĞ¹ Ğ¸Ğ»Ğ¸ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ¾Ğ¼</p>
    <button class="modal-btn" onclick="doWit()">Ğ’Ğ«Ğ’Ğ•Ğ¡Ğ¢Ğ˜</button>
    <p class="back-link" onclick="closeM()">â† ĞĞ°Ğ·Ğ°Ğ´</p>
</div>
```

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tg = window.Telegram.WebApp;
tg.expand();

let stars = 0, curBet = 5, isSpinning = false;
let userId       = new URLSearchParams(location.search).get('uid') || 'unknown';
let hasFreeSpins = 0;
const MIN_WITHDRAW = 500, MIN_DEPOSIT = 10;

/* â”€â”€â”€ TON rate â”€â”€â”€ */
let tonPerStar = 0.013333; // default

async function fetchRate() {
    try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd', {cache:'no-cache'});
        if (r.ok) {
            const d  = await r.json();
            const tu = d['the-open-network']?.usd;
            if (tu && tu > 0) {
                tonPerStar = 0.013 / tu;
                document.getElementById('rate-label').textContent =
                    `ĞšÑƒÑ€Ñ: 1 â­ â‰ˆ ${tonPerStar.toFixed(5)} TON  (TON = $${tu.toFixed(2)})`;
                calcWit();
                return;
            }
        }
    } catch(_) {}
    document.getElementById('rate-label').textContent =
        `ĞšÑƒÑ€Ñ: 1 â­ â‰ˆ ${tonPerStar.toFixed(5)} TON (Ğ±ĞµĞ· ÑƒÑ‡Ñ‘Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸)`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let soundEnabled = true;
let bgLoopTimer  = null, bgGain = null;
const actx = new (window.AudioContext || window.webkitAudioContext)();

function ensureAudio() {
    return actx.state === 'suspended' ? actx.resume() : Promise.resolve();
}

function startBgMusic() {
    if (!soundEnabled || bgLoopTimer) return;
    bgGain = actx.createGain(); bgGain.gain.value = 0.05;
    bgGain.connect(actx.destination);
    const mel = [
        [523.25,.00,.35],[659.25,.45,.35],[783.99,.9,.35],
        [1046.5,1.35,.55],[783.99,2.0,.25],[659.25,2.35,.25],
        [523.25,2.7,.35],[493.88,3.15,.35],[392.00,3.6,.35],
        [523.25,4.0,.4],[659.25,4.5,.35],[783.99,4.95,.35],
        [880.00,5.4,.55],[783.99,6.05,.25],[659.25,6.4,.25],[523.25,6.75,.9]
    ];
    const bas = [[130.81,0],[130.81,1.35],[98.00,2.7],[130.81,4.0],[130.81,5.4]];
    const LOOP = 8.0;
    function sched(t0) {
        if (!bgGain) return;
        mel.forEach(([f,t,d])=>{ const o=actx.createOscillator(),g=actx.createGain();
            o.connect(g);g.connect(bgGain);o.type='triangle';o.frequency.value=f;
            const s=t0+t; g.gain.setValueAtTime(0,s);
            g.gain.linearRampToValueAtTime(.6,s+.03);g.gain.exponentialRampToValueAtTime(.001,s+d);
            o.start(s);o.stop(s+d+.05); });
        bas.forEach(([f,t])=>{ const o=actx.createOscillator(),g=actx.createGain();
            o.connect(g);g.connect(bgGain);o.type='sine';o.frequency.value=f;
            const s=t0+t; g.gain.setValueAtTime(0,s);g.gain.linearRampToValueAtTime(.4,s+.05);
            g.gain.exponentialRampToValueAtTime(.001,s+.5);o.start(s);o.stop(s+.6); });
    }
    let t = actx.currentTime + .1; sched(t);
    bgLoopTimer = setInterval(()=>{ if(!soundEnabled){stopBgMusic();return;} t+=LOOP; sched(t); }, (LOOP-.4)*1000);
}
function stopBgMusic() {
    if (bgLoopTimer){clearInterval(bgLoopTimer);bgLoopTimer=null;}
    if (bgGain){bgGain.gain.linearRampToValueAtTime(0,actx.currentTime+.3);bgGain=null;}
}
function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-btn').textContent = soundEnabled?'ğŸ”Š':'ğŸ”‡';
    if (soundEnabled) ensureAudio().then(startBgMusic); else stopBgMusic();
}

function tone(freq,type,dur,vol) {
    if(!soundEnabled) return;
    const o=actx.createOscillator(),g=actx.createGain();
    o.connect(g);g.connect(actx.destination);
    o.type=type;o.frequency.value=freq;
    g.gain.setValueAtTime(vol,actx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+dur);
    o.start();o.stop(actx.currentTime+dur);
}
function playWin()  { [523,659,783,1046].forEach((f,i)=>setTimeout(()=>tone(f,'triangle',.3,.3),i*80)); }
function playLose() { [300,220,160].forEach((f,i)=>setTimeout(()=>tone(f,'sawtooth',.2,.2),i*100)); }
function playFree() { [659,880,1108].forEach((f,i)=>setTimeout(()=>tone(f,'sine',.25,.25),i*90)); }
function playClick(){ if(!soundEnabled)return; tone(800,'square',.05,.1); if(tg.HapticFeedback)tg.HapticFeedback.impactOccurred('light'); }

let ratchetTimer=null;
function startRatchet(ms){
    stopRatchet();
    ratchetTimer=setInterval(()=>{
        if(!soundEnabled||actx.state==='suspended')return;
        const o=actx.createOscillator(),g=actx.createGain();
        o.connect(g);g.connect(actx.destination);
        o.type='square';o.frequency.value=900;
        g.gain.setValueAtTime(.07,actx.currentTime);
        g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.04);
        o.start();o.stop(actx.currentTime+.04);
    },ms);
}
function stopRatchet(){ if(ratchetTimer){clearInterval(ratchetTimer);ratchetTimer=null;} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTORS â€” weights tuned to target probs
   lose 50% | x1 20% | x2 15% | x5 10%
   x10 4%   | free .5% | x100 .5%
   Distributed across 13 sectors (SB=0 weight)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// lose Ã—3 => 50/3â‰ˆ16.67 each
// x1   Ã—2 => 20/2=10 each
// x2   Ã—2 => 15/2=7.5 each
// x5   Ã—1 => 10
// x10  Ã—1 => 4
// FREE Ã—2 => .5/2=.25 each
// x100 Ã—1 => .5
// SB   Ã—1 => 0
const SUPERBONUS_INDEX = 5;
const sectors = [
    {t:'ğŸ’€',   c:'#1a1a1a', mult:0,   weight:16.67, isSB:false},
    {t:'Ã—1',   c:'#555555', mult:1,   weight:10,    isSB:false},
    {t:'FREE', c:'#27ae60', mult:0,   weight:.25,   isSB:false, isFree:true},
    {t:'Ã—2',   c:'#3498db', mult:2,   weight:7.5,   isSB:false},
    {t:'ğŸ’€',   c:'#1a1a1a', mult:0,   weight:16.67, isSB:false},
    {t:'â˜…SB',  c:'#7a4800', mult:0,   weight:0,     isSB:true },
    {t:'Ã—5',   c:'#9b59b6', mult:5,   weight:10,    isSB:false},
    {t:'Ã—1',   c:'#555555', mult:1,   weight:10,    isSB:false},
    {t:'Ã—10',  c:'#f39c12', mult:10,  weight:4,     isSB:false},
    {t:'FREE', c:'#27ae60', mult:0,   weight:.25,   isSB:false, isFree:true},
    {t:'Ã—100', c:'#e74c3c', mult:100, weight:.5,    isSB:false},
    {t:'ğŸ’€',   c:'#1a1a1a', mult:0,   weight:16.66, isSB:false},
    {t:'Ã—2',   c:'#3498db', mult:2,   weight:7.5,   isSB:false}
];

const N   = sectors.length;
const ARC = (Math.PI * 2) / N;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');
let curAngle = 0;
let hlIdx = -1, hlPhase = 0, hlRemain = 0, hlRAF = null;

function draw(angle, hi, phase) {
    ctx.clearRect(0,0,600,600);
    sectors.forEach((s,i) => {
        const a = i*ARC + angle;
        if (s.isSB) {
            const g=ctx.createRadialGradient(300,300,60,300,300,280);
            g.addColorStop(0,'#fff3a0');g.addColorStop(.3,'#ffd700');
            g.addColorStop(.7,'#cc8800');g.addColorStop(1,'#7a4800');
            ctx.beginPath();ctx.fillStyle=g;ctx.moveTo(300,300);ctx.arc(300,300,280,a,a+ARC);ctx.fill();
            ctx.save();ctx.shadowColor='#ffd700';ctx.shadowBlur=28;
            ctx.beginPath();ctx.strokeStyle='#ffd700';ctx.lineWidth=4;
            ctx.moveTo(300,300);ctx.arc(300,300,278,a,a+ARC);ctx.lineTo(300,300);ctx.stroke();ctx.restore();
        } else {
            ctx.beginPath();ctx.fillStyle=s.c;ctx.moveTo(300,300);ctx.arc(300,300,280,a,a+ARC);ctx.fill();
        }
        // Highlight
        if (i===hi && hlRemain>0) {
            const pulse = .45 + .55*Math.abs(Math.sin(phase*.009));
            ctx.save();
            const hg=ctx.createRadialGradient(300,300,80,300,300,280);
            hg.addColorStop(0,`rgba(255,255,180,${.22*pulse})`);
            hg.addColorStop(.6,`rgba(255,210,0,${.4*pulse})`);
            hg.addColorStop(1,'rgba(255,160,0,0)');
            ctx.beginPath();ctx.fillStyle=hg;ctx.moveTo(300,300);ctx.arc(300,300,280,a,a+ARC);ctx.fill();
            ctx.shadowColor=`rgba(255,220,50,${pulse})`;ctx.shadowBlur=32;
            ctx.beginPath();ctx.strokeStyle=`rgba(255,230,60,${.95*pulse})`;ctx.lineWidth=9;
            ctx.moveTo(300,300);ctx.arc(300,300,274,a,a+ARC);ctx.lineTo(300,300);ctx.stroke();
            ctx.restore();
        }
        // Divider
        ctx.beginPath();ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=1;
        ctx.moveTo(300,300);ctx.arc(300,300,280,a,a+ARC);ctx.lineTo(300,300);ctx.stroke();
        // Text
        ctx.save();ctx.translate(300,300);ctx.rotate(a+ARC/2);
        if (s.isSB) {
            ctx.shadowColor='#ffd700';ctx.shadowBlur=16;
            ctx.fillStyle='#fff';ctx.font='bold 15px Arial';
            ctx.fillText('SUPER',120,-10);ctx.fillText('BONUS',120,10);
            ctx.font='bold 12px Arial';ctx.fillStyle='#ffe066';
            ctx.fillText('500 TON',118,28);ctx.shadowBlur=0;
        } else {
            ctx.fillStyle='white';ctx.font='bold 28px Arial';ctx.fillText(s.t,148,10);
        }
        ctx.restore();
    });
}

function startHighlight(idx) {
    hlIdx=idx; hlRemain=4000; hlPhase=0;
    let last=null;
    function loop(now){
        if(!last)last=now; const dt=now-last; last=now;
        hlRemain-=dt; hlPhase+=dt;
        draw(curAngle, hlRemain>0?hlIdx:-1, hlPhase);
        if(hlRemain>0) hlRAF=requestAnimationFrame(loop);
        else { hlIdx=-1; draw(curAngle,-1,0); }
    }
    if(hlRAF)cancelAnimationFrame(hlRAF);
    hlRAF=requestAnimationFrame(loop);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POINTER â€” spring physics
   The pointer visually tilts (rotates around its base)
   proportional to wheel angular velocity,
   then oscillates back to 0Â° with damping.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ptrEl     = document.getElementById('ptr');
let ptrAngle    = 0;   // current tilt angle (degrees)
let ptrVel      = 0;   // angular velocity (deg/s)
let ptrTarget   = 0;   // target angle = follows wheel speed * k
let ptrRAF      = null;
let ptrLastTime = null;

const PTR_SPRING  = 18;   // spring stiffness (higher = snappier)
const PTR_DAMP    = 6;    // damping
const PTR_MAXLEAN = 28;   // max degrees of lean

function updatePointer(now) {
    if (!ptrLastTime) ptrLastTime = now;
    const dt = Math.min(now - ptrLastTime, 50) / 1000; // seconds, cap at 50ms
    ptrLastTime = now;

    const err = ptrTarget - ptrAngle;
    const acc = PTR_SPRING * err - PTR_DAMP * ptrVel;
    ptrVel   += acc * dt;
    ptrAngle += ptrVel * dt;

    ptrEl.style.transform = `translateX(-50%) rotate(${ptrAngle}deg)`;

    if (Math.abs(err) > 0.05 || Math.abs(ptrVel) > 0.05) {
        ptrRAF = requestAnimationFrame(updatePointer);
    } else {
        ptrAngle = ptrTarget; ptrVel = 0;
        ptrEl.style.transform = `translateX(-50%) rotate(${ptrAngle}deg)`;
        ptrRAF = null; ptrLastTime = null;
    }
}
function setPointerTarget(targetDeg) {
    ptrTarget = Math.max(-PTR_MAXLEAN, Math.min(PTR_MAXLEAN, targetDeg));
    if (!ptrRAF) {
        ptrLastTime = null;
        ptrRAF = requestAnimationFrame(updatePointer);
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEIGHTED RANDOM (SuperBonus excluded)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getWeightedRandom() {
    const avail = sectors.map((s,i)=>({...s,idx:i})).filter(s=>!s.isSB);
    const total = avail.reduce((sum,s)=>sum+s.weight,0);
    let r = Math.random()*total;
    for(const s of avail){ r-=s.weight; if(r<=0)return s.idx; }
    return avail[0].idx;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BALANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadBalance() {
    const urlBal = parseInt(new URLSearchParams(location.search).get('balance'));
    if (tg.CloudStorage) {
        tg.CloudStorage.getItem(`balance_${userId}`, (err,val) => {
            const saved = (!err&&val) ? parseInt(val) : NaN;
            if (!isNaN(saved)&&saved>=0) {
                stars = (!isNaN(urlBal)&&urlBal>saved) ? urlBal : saved;
            } else {
                stars = (!isNaN(urlBal)&&urlBal>=0) ? urlBal : 0;
            }
            if (!isNaN(urlBal)&&urlBal>(isNaN(saved)?-1:saved)) saveBalance();
            update();
        });
    } else {
        stars = (!isNaN(urlBal)&&urlBal>=0) ? urlBal : 0;
        update();
    }
}
function saveBalance(cb) {
    if (tg.CloudStorage) {
        tg.CloudStorage.setItem(`balance_${userId}`, stars.toString(), err=>{ if(!err)console.log('ğŸ’¾',stars); if(cb)cb(); });
    } else if(cb) cb();
}
function update() {
    document.getElementById('s_bal').innerText   = stars;
    document.getElementById('cur_bet').innerText = curBet;
    const btn = document.getElementById('spinBtn');
    if (hasFreeSpins>0) {
        btn.innerText=`ğŸ FREE SPIN (${hasFreeSpins})`;
        btn.classList.remove('dep-mode');btn.classList.add('free-mode');
    } else if (stars<curBet) {
        btn.innerText='ĞŸĞĞŸĞĞ›ĞĞ˜Ğ¢Ğ¬';
        btn.classList.add('dep-mode');btn.classList.remove('free-mode');
    } else {
        btn.innerText='ĞšĞ Ğ£Ğ¢Ğ˜Ğ¢Ğ¬';
        btn.classList.remove('dep-mode','free-mode');
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const histArr=[];
function addHistory(label,cls){
    histArr.unshift({label,cls});
    if(histArr.length>12)histArr.pop();
    const bar=document.getElementById('history-bar');
    bar.innerHTML='';
    histArr.forEach(item=>{
        const c=document.createElement('div');
        c.className=`h-chip ${item.cls}`;
        c.textContent=item.label;
        bar.appendChild(c);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPIN â€” realistic ease-in â†’ ease-out
   Random "border land" effect: sometimes
   stops right on sector boundary (Â±5% of ARC)
   or skips one sector forward without full rev
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function angleForSector(idx) {
    // pointer at top = -Ï€/2; sector center under pointer:
    // idx*ARC + ARC/2 + angle â‰¡ -Ï€/2  (mod 2Ï€)
    return -Math.PI/2 - idx*ARC - ARC/2;
}

function handleSpin() {
    if (isSpinning) return;
    if (hasFreeSpins===0&&stars<curBet) { openM(); return; }
    if (hlRAF){ cancelAnimationFrame(hlRAF); hlRAF=null; hlIdx=-1; }
    ensureAudio().then(()=>{ startBgMusic(); doSpin(); });
}

function doSpin() {
    playClick();
    isSpinning = true;

    let isFree=false;
    if(hasFreeSpins>0){hasFreeSpins--;isFree=true;}
    else{stars-=curBet;}
    update(); saveBalance();

    const realIdx  = getWeightedRandom();
    // near-miss on SuperBonus: 45% chance
    const nearMiss = Math.random() < .45;
    let   finalIdx = nearMiss ? (SUPERBONUS_INDEX+1)%N : realIdx;

    // Random border effect: 20% chance â€” stop slightly before border of finalIdx
    // so pointer visually "trembles" on the line
    const borderEffect = !nearMiss && Math.random() < .20;
    const borderOffset  = borderEffect ? (Math.random()*.06 - .03) * ARC : 0;

    let finalAngle = angleForSector(finalIdx) + borderOffset;

    // Min 7 full rotations forward
    const minAngle = curAngle + Math.PI*2*7;
    while (finalAngle < minAngle) finalAngle += Math.PI*2;

    // Random extra (0â€“1.5) rotations for variety
    const extraRot   = Math.floor(Math.random()*1.5 + .5) * Math.PI*2;
    finalAngle      += extraRot;

    const totalRot  = finalAngle - curAngle;
    const startAngle = curAngle;

    // Duration 4.8â€“7s
    const dur = nearMiss ? 7000 : 4800 + Math.random()*1400;

    let t0=null, lastRatchetSpd=45;
    startRatchet(45);

    // Ease-in-out quintic
    function eio(p) { return p<.5 ? 16*p*p*p*p*p : 1-Math.pow(-2*p+2,5)/2; }

    // Near-miss easing: fast â†’ pause near SB â†’ final crawl
    function easedFn(p) {
        if (nearMiss) {
            if (p<.68)  return eio(p/.68)*.71;
            if (p<.84)  { const q=(p-.68)/.16; return .71+.03*(1-Math.pow(1-q,2)); }
            /* crawl */  const q=(p-.84)/.16; return .74+.26*(1-Math.pow(1-q,3));
        }
        return eio(p);
    }

    let prevEased = 0;

    function frame(now) {
        if(!t0) t0=now;
        const p  = Math.min((now-t0)/dur, 1);
        const e  = easedFn(p);
        const de = e - prevEased; // delta fraction
        prevEased = e;

        curAngle = startAngle + totalRot*e;
        draw(curAngle,-1,0);

        // Pointer leans proportional to angular velocity
        // velocity = totalRot * (de/dt) ; dt â‰ˆ 16ms
        const angVelRad = totalRot * de / .016;
        const leanDeg   = Math.min(PTR_MAXLEAN, Math.abs(angVelRad) * .08);
        setPointerTarget(angVelRad > 0 ? -leanDeg : leanDeg); // leans against direction

        // Ratchet speed
        const spd = p>.88?220:p>.68?110:45;
        if(spd!==lastRatchetSpd){ lastRatchetSpd=spd; startRatchet(spd); }

        if (p<1) { requestAnimationFrame(frame); return; }

        // â”€â”€ STOP â”€â”€
        stopRatchet();
        setPointerTarget(0); // snap back to center
        isSpinning = false;
        curAngle   = finalAngle; // exact

        const win = sectors[finalIdx];
        let winAmount = 0;

        if (win.isFree) {
            hasFreeSpins++;
            playFree();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('success');
            addHistory('ğŸ FREE','h-free');
        } else if (win.mult>0) {
            winAmount = curBet * win.mult;
            stars    += winAmount;  // âœ… correct calculation
            playWin();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('success');
            addHistory(isFree?`ğŸ+${winAmount}â­`:`${win.t} +${winAmount}â­`,'h-win');
        } else {
            playLose();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('error');
            addHistory(isFree?'ğŸğŸ’€':`âˆ’${curBet}â­`,'h-lose');
        }

        startHighlight(finalIdx);
        saveBalance();
        update();
    }
    requestAnimationFrame(frame);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openM()  { playClick(); document.getElementById('modal').classList.add('open'); }
function closeM() { playClick(); document.getElementById('modal').classList.remove('open'); }
function setTab(t,el) {
    playClick();
    document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById(t).classList.add('active'); el.classList.add('active');
}

/* â”€â”€â”€ DEPOSIT â”€â”€â”€ */
function doDep() {
    playClick();
    const val = parseInt(document.getElementById('dep_val').value);
    if (!val||isNaN(val)||val<MIN_DEPOSIT) {
        tg.showAlert(`âŒ ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: ${MIN_DEPOSIT} â­`); return;
    }
    tg.sendData(JSON.stringify({action:'deposit', amount:val, currentBalance:stars}));
}

/* â”€â”€â”€ WITHDRAW â€” deducts balance â”€â”€â”€ */
function calcWit() {
    const v = parseInt(document.getElementById('w_stars').value)||0;
    const ton = (v*tonPerStar).toFixed(4);
    document.getElementById('wit_preview').textContent = v>0?`Ğ’Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ: â‰ˆ ${ton} TON`:'Ğ’Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ: â€” TON';
}
function doWit() {
    playClick();
    const val  = parseInt(document.getElementById('w_stars').value);
    const addr = document.getElementById('w_addr').value.trim();
    const memo = document.getElementById('w_memo').value.trim();
    if (!addr)                           { tg.showAlert('âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ TON!'); return; }
    if (!val||isNaN(val)||val<=0)        { tg.showAlert('âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ!'); return; }
    if (val<MIN_WITHDRAW)                { tg.showAlert(`âŒ ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ ${MIN_WITHDRAW} â­`); return; }
    if (val>stars)                       { tg.showAlert(`âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ â­ (Ñƒ Ğ²Ğ°Ñ ${stars})`); return; }

    const ton = (val*tonPerStar).toFixed(4);

    // âœ… Deduct balance immediately
    stars -= val;
    saveBalance();
    update();

    // Send full info to bot (memo always included)
    tg.sendData(JSON.stringify({
        action:   'withdraw',
        stars:    val,
        ton:      ton,
        rate:     `1 â­ = ${tonPerStar.toFixed(6)} TON`,
        address:  addr,
        memo:     memo || 'â€”',
        balanceAfter: stars
    }));

    closeM();
}

/* â”€â”€â”€ BET â”€â”€â”€ */
function adjBet(v) { playClick(); curBet=Math.max(5,curBet+v); update(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('beforeunload', ()=>saveBalance());
window.addEventListener('DOMContentLoaded', ()=>{
    loadBalance();
    draw(0,-1,0);
    fetchRate();
});
</script>

</body>
</html>