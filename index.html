<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magik Spin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden;
            background: #050505; color: white;
            font-family: 'Segoe UI', sans-serif;
        }
        body {
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
            height: 100dvh;
        }

```
    /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
    .top-bar {
        width: 100%; padding: 8px 0 4px;
        display: flex; justify-content: center; position: relative;
        flex-shrink: 0;
    }
    .bal-display {
        font-size: 2.2em; font-weight: bold; color: gold;
        text-shadow: 0 0 15px rgba(255,215,0,0.6);
    }
    .wallet-btn {
        position: absolute; right: 15px; top: 50%;
        transform: translateY(-50%);
        background: rgba(142,68,173,0.3); border: 1px solid #8e44ad;
        color: white; border-radius: 8px; padding: 6px 12px;
        font-size: 0.8em; cursor: pointer;
    }

    /* ‚îÄ‚îÄ SUPERBONUS BANNER (top-left, z:50, hidden under modal z:100) ‚îÄ‚îÄ */
    #sb-banner {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 8px);
        left: 10px; z-index: 50;
        background: linear-gradient(135deg, #1a0f00, #2d1a00, #1a0f00);
        border: 1.5px solid #ffd700; border-radius: 10px;
        padding: 5px 12px 5px 8px;
        display: flex; align-items: center; gap: 6px;
        box-shadow: 0 0 8px #ffd700, 0 0 20px #ffaa00;
        animation: sbPulse 2.2s ease-in-out infinite;
        pointer-events: none;
    }
    @keyframes sbPulse {
        0%,100% { box-shadow:0 0 8px #ffd700,0 0 20px #ffaa00,0 0 35px rgba(255,136,0,.4); }
        50%      { box-shadow:0 0 16px #ffd700,0 0 36px #ffaa00,0 0 65px rgba(255,136,0,.7); }
    }
    .sb-crown  { font-size:20px; filter:drop-shadow(0 0 6px #ffd700); }
    .sb-text   { display:flex; flex-direction:column; line-height:1.2; }
    .sb-label  { font-size:8px; font-weight:900; letter-spacing:2px; color:#ffd700; text-transform:uppercase; }
    .sb-amount { font-size:14px; font-weight:900; color:#fff; text-shadow:0 0 8px #ffd700; }

    /* ‚îÄ‚îÄ WHEEL ‚îÄ‚îÄ */
    .wheel-container {
        position: relative;
        /* Fills remaining space between top-bar and controls */
        flex: 1;
        display: flex; align-items: center; justify-content: center;
        width: 100%;
    }
    .wheel-inner {
        position: relative;
        width: min(80vw, calc(100dvh - 220px));
        aspect-ratio: 1/1;
    }
    canvas {
        width: 100%; height: 100%;
        filter: drop-shadow(0 0 15px #8e44ad);
        display: block;
    }
    /* Pointer */
    #ptr {
        position: absolute; top: -10px; left: 50%;
        transform: translateX(-50%) rotate(0deg);
        transform-origin: 50% 100%;
        width: 0; height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-top: 25px solid #f1c40f;
        z-index: 10;
        filter: drop-shadow(0 0 8px rgba(241,196,15,0.8));
        will-change: transform;
    }

    /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
    #history-bar {
        width: 90%; max-width: 320px;
        display: flex; gap: 5px; overflow-x: auto;
        padding: 2px 0; scrollbar-width: none; flex-shrink: 0;
    }
    #history-bar::-webkit-scrollbar { display: none; }
    .h-chip {
        flex-shrink: 0; border-radius: 20px; padding: 3px 9px;
        font-size: .72em; font-weight: bold; white-space: nowrap;
        opacity: 0; transform: scale(.5); animation: chipIn .3s forwards;
    }
    @keyframes chipIn { to { opacity:1; transform:scale(1); } }
    .h-win  { background:rgba(39,174,96,.22);  border:1px solid #27ae60; color:#2ecc71; }
    .h-lose { background:rgba(231,76,60,.22);   border:1px solid #e74c3c; color:#e74c3c; }
    .h-free { background:rgba(52,152,219,.22);  border:1px solid #3498db; color:#74b9ff; }

    /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
    .controls {
        width: 100%; text-align: center;
        padding-bottom: 16px; flex-shrink: 0;
    }
    .bet-box {
        display: flex; align-items: center;
        justify-content: center; gap: 20px;
        margin-bottom: 12px;
    }
    #sound-btn {
        background: rgba(142,68,173,0.3); border: 1px solid #8e44ad;
        color: white; border-radius: 50%;
        width: 46px; height: 46px; font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }
    .btn-adj {
        background: #8e44ad; border: none; color: white;
        width: 50px; height: 50px; border-radius: 50%; font-size: 1.5em;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }
    .bet-label {
        font-size: 1em; line-height: 1.4;
        min-width: 70px; text-align: center;
    }
    .bet-label b { font-size: 1.2em; }
    .spin-btn {
        width: 85%; padding: 18px; border-radius: 50px; border: none;
        color: white; font-weight: bold; font-size: 1.4em;
        background: #8e44ad; box-shadow: 0 0 25px #8e44ad;
        transition: all .3s; cursor: pointer;
    }
    .dep-mode  { background:#e74c3c!important; box-shadow:0 0 25px #e74c3c!important; }
    .free-mode { background:#27ae60!important; box-shadow:0 0 25px #27ae60!important; }

    /* ‚îÄ‚îÄ MODAL (wallet) ‚îÄ‚îÄ */
    #modal {
        display: none; position: fixed; inset: 0;
        background: #000; z-index: 100;
        flex-direction: column; overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    #modal.open { display: flex; }
    .tabs { display: flex; background: #1a1a1a; flex-shrink: 0; }
    .tab { flex:1; padding: 18px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { border-bottom: 3px solid #8e44ad; color: #8e44ad; }
    .tab-content {
        display: none; padding: 24px 20px 80px;
        flex-direction: column; align-items: center; width: 100%;
    }
    .tab-content.active { display: flex; }
    .modal-input {
        width: 100%; padding: 15px; margin: 8px 0;
        border-radius: 12px; border: 1px solid #444;
        background: #111; color: white; font-size: 1em;
    }
    .modal-input:focus { outline: none; border-color: #8e44ad; }
    .m-hint    { color: #666; font-size: .8em; text-align: center; margin: 2px 0 8px; line-height: 1.4; }
    .m-warn    { color: #e74c3c; font-size: .85em; text-align: center; margin: 6px 0; }
    .m-preview { color: #0af; font-size: 1.05em; font-weight: bold; margin: 10px 0 2px; }
    .m-rate    { color: #777; font-size: .75em; text-align: center; margin-bottom: 4px; }
    .modal-btn {
        width: 100%; padding: 17px; border-radius: 50px; border: none;
        color: white; font-weight: bold; font-size: 1.2em;
        background: #8e44ad; box-shadow: 0 0 20px #8e44ad;
        margin-top: 14px; cursor: pointer;
    }
    .modal-btn.green { background: #27ae60; box-shadow: 0 0 20px #27ae60; }
    .back-link { margin-top: 24px; color: #777; font-size: .9em; cursor: pointer; }
</style>
```

</head>
<body>

<!-- SuperBonus Banner (top-left, hidden under modal) -->

<div id="sb-banner">
    <span class="sb-crown">üëë</span>
    <div class="sb-text">
        <span class="sb-label">SuperBonus</span>
        <span class="sb-amount">500 TON</span>
    </div>
</div>

<!-- Top Bar -->

<div class="top-bar">
    <div class="bal-display">‚≠ê <span id="s_bal">0</span></div>
    <button class="wallet-btn" onclick="openM()">–ö–æ—à–µ–ª–µ–∫</button>
</div>

<!-- Wheel (fills remaining space) -->

<div class="wheel-container">
    <div class="wheel-inner">
        <div id="ptr"></div>
        <canvas id="canvas" width="600" height="600"></canvas>
    </div>
</div>

<!-- History -->

<div id="history-bar"></div>

<!-- Controls -->

<div class="controls">
    <div class="bet-box">
        <button id="sound-btn" onclick="toggleSound()">üîä</button>
        <button class="btn-adj" onclick="adjBet(-5)">-</button>
        <div class="bet-label">–°—Ç–∞–≤–∫–∞<br><b id="cur_bet">5</b> ‚≠ê</div>
        <button class="btn-adj" onclick="adjBet(5)">+</button>
    </div>
    <button id="spinBtn" class="spin-btn" onclick="handleSpin()">–ö–†–£–¢–ò–¢–¨</button>
</div>

<!-- Modal Wallet -->

<div id="modal">
    <div class="tabs">
        <div class="tab active" id="tab-dep" onclick="setTab('dep',this)">–ü–û–ü–û–õ–ù–ò–¢–¨</div>
        <div class="tab"        id="tab-wit" onclick="setTab('wit',this)">–í–´–í–û–î</div>
    </div>

```
<!-- DEPOSIT -->
<div id="dep" class="tab-content active">
    <h2 style="color:gold; margin-bottom:4px;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚≠ê</h2>
    <p class="m-warn">–ú–∏–Ω–∏–º—É–º 10 ‚≠ê</p>
    <input class="modal-input" type="number" id="dep_val"
           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥" min="10" inputmode="numeric">
    <p class="m-hint">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</p>
    <button class="modal-btn green" onclick="doDep()">–ö–£–ü–ò–¢–¨ ‚≠ê</button>
    <p class="back-link" onclick="closeM()">‚Üê –ù–∞–∑–∞–¥</p>
</div>

<!-- WITHDRAW -->
<div id="wit" class="tab-content">
    <h2 style="color:#0088cc; margin-bottom:4px;">–í—ã–≤–æ–¥ TON</h2>
    <p class="m-warn">–ú–∏–Ω–∏–º—É–º 500 ‚≠ê</p>

    <input class="modal-input" type="number" id="w_stars"
           placeholder="–°—É–º–º–∞ –∑–≤—ë–∑–¥ (–º–∏–Ω. 500)" inputmode="numeric" oninput="calcWit()">
    <div class="m-preview" id="wit_preview">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚Äî TON</div>
    <p class="m-rate" id="rate-label">–ö—É—Ä—Å: –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>

    <input class="modal-input" type="text" id="w_addr" placeholder="–ê–¥—Ä–µ—Å TON (UQ...)">
    <input class="modal-input" type="text" id="w_memo" placeholder="MEMO / Tag">
    <p class="m-hint">MEMO ‚Äî –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–∏—Ä–∂–µ–π –∏–ª–∏ –∫–æ—à–µ–ª—å–∫–æ–º</p>

    <button class="modal-btn" onclick="doWit()">–í–´–í–ï–°–¢–ò</button>
    <p class="back-link" onclick="closeM()">‚Üê –ù–∞–∑–∞–¥</p>
</div>
```

</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const tg = window.Telegram.WebApp;
tg.expand();

let stars = 0, curBet = 5, isSpinning = false;
let userId       = new URLSearchParams(location.search).get('uid') || 'unknown';
let hasFreeSpins = 0;
const MIN_WITHDRAW = 500, MIN_DEPOSIT = 10;

/* ‚îÄ‚îÄ‚îÄ TON Rate ‚îÄ‚îÄ‚îÄ */
let tonPerStar = 0.013333;
(async function fetchRate() {
    try {
        const r = await fetch(
            'https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd',
            { cache: 'no-cache' }
        );
        if (r.ok) {
            const d  = await r.json();
            const tu = d['the-open-network']?.usd;
            if (tu && tu > 0) {
                tonPerStar = 0.013 / tu;
                document.getElementById('rate-label').textContent =
                    `–ö—É—Ä—Å: 1 ‚≠ê ‚âà ${tonPerStar.toFixed(5)} TON  (TON ‚âà $${tu.toFixed(2)})`;
                calcWit();
                return;
            }
        }
    } catch(_) {}
    document.getElementById('rate-label').textContent =
        `–ö—É—Ä—Å: 1 ‚≠ê ‚âà ${tonPerStar.toFixed(5)} TON`;
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let soundEnabled = true;
let bgLoopTimer = null, bgGain = null;
const actx = new (window.AudioContext || window.webkitAudioContext)();

function ensureAudio() {
    return actx.state === 'suspended' ? actx.resume() : Promise.resolve();
}
function startBgMusic() {
    if (!soundEnabled || bgLoopTimer) return;
    bgGain = actx.createGain(); bgGain.gain.value = 0.05;
    bgGain.connect(actx.destination);
    const mel = [
        [523.25,.00,.35],[659.25,.45,.35],[783.99,.9,.35],
        [1046.5,1.35,.55],[783.99,2.0,.25],[659.25,2.35,.25],
        [523.25,2.7,.35],[493.88,3.15,.35],[392,.3,.35],
        [523.25,4.0,.4],[659.25,4.5,.35],[783.99,4.95,.35],
        [880,5.4,.55],[783.99,6.05,.25],[659.25,6.4,.25],[523.25,6.75,.9]
    ];
    const bas = [[130.81,0],[130.81,1.35],[98,2.7],[130.81,4.0],[130.81,5.4]];
    const LOOP = 8.0;
    function sched(t0) {
        if (!bgGain) return;
        mel.forEach(([f,t,d])=>{
            const o=actx.createOscillator(),g=actx.createGain();
            o.connect(g); g.connect(bgGain); o.type='triangle'; o.frequency.value=f;
            const s=t0+t; g.gain.setValueAtTime(0,s);
            g.gain.linearRampToValueAtTime(.6,s+.03);
            g.gain.exponentialRampToValueAtTime(.001,s+d);
            o.start(s); o.stop(s+d+.05);
        });
        bas.forEach(([f,t])=>{
            const o=actx.createOscillator(),g=actx.createGain();
            o.connect(g); g.connect(bgGain); o.type='sine'; o.frequency.value=f;
            const s=t0+t; g.gain.setValueAtTime(0,s);
            g.gain.linearRampToValueAtTime(.4,s+.05);
            g.gain.exponentialRampToValueAtTime(.001,s+.5);
            o.start(s); o.stop(s+.6);
        });
    }
    let t = actx.currentTime + .1; sched(t);
    bgLoopTimer = setInterval(()=>{
        if(!soundEnabled){stopBgMusic();return;} t+=LOOP; sched(t);
    }, (LOOP-.4)*1000);
}
function stopBgMusic() {
    if(bgLoopTimer){clearInterval(bgLoopTimer);bgLoopTimer=null;}
    if(bgGain){bgGain.gain.linearRampToValueAtTime(0,actx.currentTime+.3);bgGain=null;}
}
function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
    if(soundEnabled) ensureAudio().then(startBgMusic); else stopBgMusic();
}
function tone(f,type,dur,vol) {
    if(!soundEnabled) return;
    const o=actx.createOscillator(),g=actx.createGain();
    o.connect(g); g.connect(actx.destination);
    o.type=type; o.frequency.value=f;
    g.gain.setValueAtTime(vol,actx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+dur);
    o.start(); o.stop(actx.currentTime+dur);
}
function playWin()  { [523,659,783,1046].forEach((f,i)=>setTimeout(()=>tone(f,'triangle',.3,.3),i*80)); }
function playLose() { [300,220,160].forEach((f,i)=>setTimeout(()=>tone(f,'sawtooth',.2,.2),i*100)); }
function playFree() { [659,880,1108].forEach((f,i)=>setTimeout(()=>tone(f,'sine',.25,.25),i*90)); }
function playClick(){
    if(!soundEnabled)return;
    tone(800,'square',.05,.1);
    if(tg.HapticFeedback)tg.HapticFeedback.impactOccurred('light');
}

let ratchetTimer=null;
function startRatchet(ms){
    stopRatchet();
    ratchetTimer=setInterval(()=>{
        if(!soundEnabled||actx.state==='suspended')return;
        const o=actx.createOscillator(),g=actx.createGain();
        o.connect(g); g.connect(actx.destination);
        o.type='square'; o.frequency.value=900;
        g.gain.setValueAtTime(.07,actx.currentTime);
        g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.04);
        o.start(); o.stop(actx.currentTime+.04);
    }, ms);
}
function stopRatchet(){ if(ratchetTimer){clearInterval(ratchetTimer);ratchetTimer=null;} }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SECTORS
   lose 55% | x1 18% | x2 12% | x5 9%
   x10 4%   | FREE 0.5% | x100 1.5%
   Total = 100%. Distributed across 13 sectors.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// lose √ó3 ‚Üí 55/3 ‚âà 18.33 each
// x1  √ó2 ‚Üí 18/2 = 9 each
// x2  √ó2 ‚Üí 12/2 = 6 each
// x5  √ó1 ‚Üí 9
// x10 √ó1 ‚Üí 4
// FREE√ó2 ‚Üí 0.5/2 = 0.25 each
// x100√ó1 ‚Üí 1.5
// SB  √ó1 ‚Üí 0 (never selected)

const SUPERBONUS_INDEX = 5;
const sectors = [
    {t:'üíÄ',   c:'#1a1a1a', mult:0,   weight:18.33, isSB:false, isFree:false},
    {t:'√ó1',   c:'#555555', mult:1,   weight:9,     isSB:false, isFree:false},
    {t:'FREE', c:'#27ae60', mult:0,   weight:0.25,  isSB:false, isFree:true },
    {t:'√ó2',   c:'#3498db', mult:2,   weight:6,     isSB:false, isFree:false},
    {t:'üíÄ',   c:'#1a1a1a', mult:0,   weight:18.33, isSB:false, isFree:false},
    {t:'‚òÖSB',  c:'#7a4800', mult:0,   weight:0,     isSB:true,  isFree:false},
    {t:'√ó5',   c:'#9b59b6', mult:5,   weight:9,     isSB:false, isFree:false},
    {t:'√ó1',   c:'#555555', mult:1,   weight:9,     isSB:false, isFree:false},
    {t:'√ó10',  c:'#f39c12', mult:10,  weight:4,     isSB:false, isFree:false},
    {t:'FREE', c:'#27ae60', mult:0,   weight:0.25,  isSB:false, isFree:true },
    {t:'√ó100', c:'#e74c3c', mult:100, weight:1.5,   isSB:false, isFree:false},
    {t:'üíÄ',   c:'#1a1a1a', mult:0,   weight:18.34, isSB:false, isFree:false},
    {t:'√ó2',   c:'#3498db', mult:2,   weight:6,     isSB:false, isFree:false}
];

const N   = sectors.length;
const ARC = (Math.PI * 2) / N;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');
let curAngle = 0;
let hlIdx = -1, hlPhase = 0, hlRemain = 0, hlRAF = null;

function draw(angle, hi, phase) {
    ctx.clearRect(0,0,600,600);
    sectors.forEach((s,i) => {
        const a = i*ARC + angle;

        if (s.isSB) {
            const gr = ctx.createRadialGradient(300,300,60,300,300,280);
            gr.addColorStop(0,'#fff3a0'); gr.addColorStop(.3,'#ffd700');
            gr.addColorStop(.7,'#cc8800'); gr.addColorStop(1,'#7a4800');
            ctx.beginPath(); ctx.fillStyle=gr;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
            ctx.save();
            ctx.shadowColor='#ffd700'; ctx.shadowBlur=28;
            ctx.beginPath(); ctx.strokeStyle='#ffd700'; ctx.lineWidth=4;
            ctx.moveTo(300,300); ctx.arc(300,300,278,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();
            ctx.restore();
        } else {
            ctx.beginPath(); ctx.fillStyle=s.c;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
        }

        // Highlight winning sector
        if (i===hi && hlRemain>0) {
            const pulse = .45+.55*Math.abs(Math.sin(phase*.009));
            ctx.save();
            const hg=ctx.createRadialGradient(300,300,80,300,300,280);
            hg.addColorStop(0,`rgba(255,255,180,${.22*pulse})`);
            hg.addColorStop(.6,`rgba(255,210,0,${.4*pulse})`);
            hg.addColorStop(1,'rgba(255,160,0,0)');
            ctx.beginPath(); ctx.fillStyle=hg;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
            ctx.shadowColor=`rgba(255,220,50,${pulse})`; ctx.shadowBlur=32;
            ctx.beginPath();
            ctx.strokeStyle=`rgba(255,230,60,${.95*pulse})`; ctx.lineWidth=9;
            ctx.moveTo(300,300); ctx.arc(300,300,274,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();
            ctx.restore();
        }

        // Divider
        ctx.beginPath(); ctx.strokeStyle='rgba(255,255,255,.1)'; ctx.lineWidth=1;
        ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();

        // Text
        ctx.save(); ctx.translate(300,300); ctx.rotate(a+ARC/2);
        if (s.isSB) {
            ctx.shadowColor='#ffd700'; ctx.shadowBlur=16;
            ctx.fillStyle='#fff'; ctx.font='bold 15px Arial';
            ctx.fillText('SUPER',118,-10); ctx.fillText('BONUS',118,10);
            ctx.font='bold 12px Arial'; ctx.fillStyle='#ffe066';
            ctx.fillText('500 TON',116,28); ctx.shadowBlur=0;
        } else {
            ctx.fillStyle='white'; ctx.font='bold 28px Arial';
            ctx.fillText(s.t,148,10);
        }
        ctx.restore();
    });
}

function startHighlight(idx) {
    hlIdx=idx; hlRemain=4000; hlPhase=0;
    let last=null;
    function loop(now) {
        if(!last) last=now;
        const dt=now-last; last=now;
        hlRemain-=dt; hlPhase+=dt;
        draw(curAngle, hlRemain>0?hlIdx:-1, hlPhase);
        if(hlRemain>0) hlRAF=requestAnimationFrame(loop);
        else { hlIdx=-1; draw(curAngle,-1,0); }
    }
    if(hlRAF) cancelAnimationFrame(hlRAF);
    hlRAF=requestAnimationFrame(loop);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   POINTER ‚Äî spring physics
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ptrEl  = document.getElementById('ptr');
let ptrAngle = 0, ptrVel = 0, ptrTarget = 0;
let ptrRAF = null, ptrLast = null;

function tickPointer(now) {
    if(!ptrLast) ptrLast=now;
    const dt=Math.min(now-ptrLast,50)/1000; ptrLast=now;
    const err=ptrTarget-ptrAngle;
    ptrVel  += (20*err - 7*ptrVel)*dt;
    ptrAngle += ptrVel*dt;
    ptrEl.style.transform=`translateX(-50%) rotate(${ptrAngle.toFixed(2)}deg)`;
    if(Math.abs(err)>.05||Math.abs(ptrVel)>.05) {
        ptrRAF=requestAnimationFrame(tickPointer);
    } else {
        ptrAngle=ptrTarget; ptrVel=0;
        ptrEl.style.transform=`translateX(-50%) rotate(${ptrAngle}deg)`;
        ptrRAF=null; ptrLast=null;
    }
}
function setPointerLean(deg) {
    ptrTarget=Math.max(-30,Math.min(30,deg));
    if(!ptrRAF){ptrLast=null; ptrRAF=requestAnimationFrame(tickPointer);}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WEIGHTED RANDOM (SuperBonus excluded)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getWeightedRandom() {
    const avail=sectors.map((s,i)=>({...s,idx:i})).filter(s=>!s.isSB);
    const total=avail.reduce((s,x)=>s+x.weight,0);
    let r=Math.random()*total;
    for(const s of avail){r-=s.weight;if(r<=0)return s.idx;}
    return avail[0].idx;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BALANCE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadBalance() {
    const urlBal=parseInt(new URLSearchParams(location.search).get('balance'));
    if(tg.CloudStorage){
        tg.CloudStorage.getItem(`balance_${userId}`,(err,val)=>{
            const saved=(!err&&val)?parseInt(val):NaN;
            if(!isNaN(saved)&&saved>=0){
                stars=(!isNaN(urlBal)&&urlBal>saved)?urlBal:saved;
            } else {
                stars=(!isNaN(urlBal)&&urlBal>=0)?urlBal:0;
            }
            if(!isNaN(urlBal)&&urlBal>(isNaN(saved)?-1:saved)) saveBalance();
            update();
        });
    } else {
        stars=(!isNaN(urlBal)&&urlBal>=0)?urlBal:0;
        update();
    }
}
function saveBalance(cb) {
    if(tg.CloudStorage){
        tg.CloudStorage.setItem(`balance_${userId}`,String(stars),err=>{
            if(!err)console.log('üíæ',stars); if(cb)cb();
        });
    } else if(cb) cb();
}
function update() {
    document.getElementById('s_bal').innerText   = stars;
    document.getElementById('cur_bet').innerText = curBet;
    const btn=document.getElementById('spinBtn');
    if(hasFreeSpins>0){
        btn.innerText=`üéÅ FREE SPIN (${hasFreeSpins})`;
        btn.classList.remove('dep-mode'); btn.classList.add('free-mode');
    } else if(stars<curBet){
        btn.innerText='–ü–û–ü–û–õ–ù–ò–¢–¨';
        btn.classList.add('dep-mode'); btn.classList.remove('free-mode');
    } else {
        btn.innerText='–ö–†–£–¢–ò–¢–¨';
        btn.classList.remove('dep-mode','free-mode');
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HISTORY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const histArr=[];
function addHistory(label,cls){
    histArr.unshift({label,cls});
    if(histArr.length>12) histArr.pop();
    const bar=document.getElementById('history-bar');
    bar.innerHTML='';
    histArr.forEach(item=>{
        const c=document.createElement('div');
        c.className=`h-chip ${item.cls}`;
        c.textContent=item.label;
        bar.appendChild(c);
    });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPIN
   Physics: ease-in then ease-out (smooth accel‚Üídecel)
   Near-miss on SuperBonus 40% of spins
   Random border stop: 15%
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function angleForSector(idx) {
    return -Math.PI/2 - idx*ARC - ARC/2;
}

function handleSpin() {
    if(isSpinning) return;
    if(hasFreeSpins===0&&stars<curBet){ openM(); return; }
    if(hlRAF){cancelAnimationFrame(hlRAF);hlRAF=null;hlIdx=-1;}
    ensureAudio().then(()=>{ startBgMusic(); doSpin(); });
}

function doSpin() {
    playClick();
    isSpinning=true;
    let isFree=false;
    if(hasFreeSpins>0){hasFreeSpins--;isFree=true;}
    else{stars-=curBet;}
    update(); saveBalance();

    const realIdx  = getWeightedRandom();
    const nearMiss = Math.random()<.40;
    const finalIdx = nearMiss ? (SUPERBONUS_INDEX+1)%N : realIdx;

    // Small random offset from sector center (border effect 15%)
    const borderOff = (!nearMiss&&Math.random()<.15) ? (Math.random()*.1-.05)*ARC : 0;

    let finalAngle = angleForSector(finalIdx) + borderOff;
    // Ensure at least 6 full rotations forward from current position
    while(finalAngle < curAngle + Math.PI*2*6) finalAngle += Math.PI*2;
    // Add 0‚Äì2 random extra rotations
    finalAngle += Math.floor(Math.random()*3)*Math.PI*2;

    const totalRot = finalAngle - curAngle;
    const startAng = curAngle;
    const dur = nearMiss ? 6800 : 4500 + Math.random()*1500;

    // Smooth ease-in ‚Üí ease-out (cubic bezier approximation)
    // First 40%: accelerate (ease-in), last 60%: decelerate (ease-out)
    function eased(p) {
        if(p < 0.4) {
            // ease-in: starts slow, speeds up
            const t = p / 0.4;
            return 0.35 * (t * t * t);
        } else {
            // ease-out: fast then slow
            const t = (p - 0.4) / 0.6;
            return 0.35 + 0.65 * (1 - Math.pow(1 - t, 3));
        }
    }

    // Near-miss: pause near SuperBonus
    function easedNM(p) {
        if(p < 0.65) return eased(p/0.65)*0.70;
        if(p < 0.82) { const q=(p-.65)/.17; return .70+.03*(1-Math.pow(1-q,2)); }
        const q=(p-.82)/.18; return .73+.27*(1-Math.pow(1-q,3));
    }

    let t0=null, lastSpd=45, prevE=0;
    startRatchet(45);

    function frame(now) {
        if(!t0) t0=now;
        const p = Math.min((now-t0)/dur, 1);
        const e = nearMiss ? easedNM(p) : eased(p);
        const de = e - prevE; prevE = e;

        curAngle = startAng + totalRot*e;
        draw(curAngle,-1,0);

        // Pointer leans with spin velocity
        const radVel = totalRot*de/.016;
        const lean   = Math.min(30, Math.abs(radVel)*.09);
        setPointerLean(radVel>0 ? -lean : lean);

        // Ratchet
        const spd = p>.85?220 : p>.65?110 : 45;
        if(spd!==lastSpd){lastSpd=spd;startRatchet(spd);}

        if(p<1){ requestAnimationFrame(frame); return; }

        // ‚îÄ‚îÄ STOP ‚îÄ‚îÄ
        stopRatchet();
        setPointerLean(0);
        isSpinning=false;
        curAngle=finalAngle;

        const win=sectors[finalIdx];
        let winAmount=0;

        if(win.isFree){
            hasFreeSpins++;
            playFree();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('success');
            addHistory('üéÅ FREE','h-free');
        } else if(win.mult>0){
            winAmount=curBet*win.mult;
            stars+=winAmount;  // ‚úÖ correct
            playWin();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('success');
            addHistory(isFree?`üéÅ+${winAmount}‚≠ê`:`${win.t} +${winAmount}‚≠ê`,'h-win');
        } else {
            playLose();
            if(tg.HapticFeedback)tg.HapticFeedback.notificationOccurred('error');
            addHistory(isFree?'üéÅüíÄ':`-${curBet}‚≠ê`,'h-lose');
        }

        startHighlight(finalIdx);
        saveBalance();
        update();
    }
    requestAnimationFrame(frame);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openM()  { playClick(); document.getElementById('modal').classList.add('open'); }
function closeM() { playClick(); document.getElementById('modal').classList.remove('open'); }
function setTab(t,el) {
    playClick();
    document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById(t).classList.add('active'); el.classList.add('active');
}

/* ‚îÄ‚îÄ‚îÄ DEPOSIT ‚îÄ‚îÄ‚îÄ */
function doDep() {
    playClick();
    const val=parseInt(document.getElementById('dep_val').value);
    if(!val||isNaN(val)||val<MIN_DEPOSIT){ alert(`‚ùå –ú–∏–Ω–∏–º—É–º ${MIN_DEPOSIT} ‚≠ê`); return; }
    tg.sendData(JSON.stringify({ action:'deposit', amount:val, currentBalance:stars }));
}

/* ‚îÄ‚îÄ‚îÄ WITHDRAW ‚Äî deducts balance, sends full info to bot ‚îÄ‚îÄ‚îÄ */
function calcWit() {
    const v=(parseInt(document.getElementById('w_stars').value)||0);
    document.getElementById('wit_preview').textContent =
        v>0 ? `–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚âà ${(v*tonPerStar).toFixed(4)} TON` : '–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚Äî TON';
}
function doWit() {
    playClick();
    const val  = parseInt(document.getElementById('w_stars').value);
    const addr = document.getElementById('w_addr').value.trim();
    const memo = document.getElementById('w_memo').value.trim();

    if(!addr)                        { alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å TON!'); return; }
    if(!val||isNaN(val)||val<=0)     { alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!'); return; }
    if(val<MIN_WITHDRAW)             { alert(`‚ùå –ú–∏–Ω–∏–º—É–º ${MIN_WITHDRAW} ‚≠ê`); return; }
    if(val>stars)                    { alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê (—É –≤–∞—Å ${stars})`); return; }

    const ton = (val*tonPerStar).toFixed(4);

    // ‚úÖ Deduct balance before sending
    stars -= val;
    saveBalance();
    update();

    // Send all info to bot via sendData
    // NOTE: tg.sendData() closes the mini-app and sends web_app_data to bot.
    // Your bot must handle the 'web_app_data' update to receive this.
    tg.sendData(JSON.stringify({
        action:       'withdraw',
        stars:        val,
        ton:          ton,
        rate:         `1 ‚≠ê = ${tonPerStar.toFixed(6)} TON`,
        address:      addr,
        memo:         memo || '‚Äî',
        balanceAfter: stars
    }));
}

/* ‚îÄ‚îÄ‚îÄ BET ADJUSTMENT ‚îÄ‚îÄ‚îÄ */
function adjBet(v) { playClick(); curBet=Math.max(5,curBet+v); update(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOOT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('beforeunload', ()=>saveBalance());
window.addEventListener('DOMContentLoaded', ()=>{
    loadBalance();
    draw(0,-1,0);
});
</script>

</body>
</html>