<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Spin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        .top-bar { width: 100%; padding: 15px; display: flex; justify-content: space-around; background: #111; border-bottom: 1px solid #333; }
        .bal { font-weight: bold; font-size: 1.1em; }
        
        /* –†—É–ª–µ—Ç–∫–∞ –∏ –°—Ç–∞–≤–∫–∞ */
        .wheel-area { position: relative; width: 280px; height: 280px; margin-top: 10px; }
        canvas { width: 100%; height: 100%; }
        .pointer { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #f1c40f; z-index: 10; }
        
        .bet-ctrl { display: flex; align-items: center; gap: 20px; margin: 15px 0; }
        .btn-s { background: #8e44ad; border: none; color: white; width: 40px; height: 40px; border-radius: 10px; font-size: 1.5em; }
        
        .spin-btn { width: 80%; padding: 15px; border-radius: 20px; border: none; color: white; font-weight: bold; font-size: 1.2em; cursor: pointer; }
        .btn-active { background: linear-gradient(135deg, #8e44ad, #6c3483); }
        .btn-error { background: #c0392b !important; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –í–∫–ª–∞–¥–∫–∏ */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; }
        .tabs { display: flex; width: 100%; background: #1a1a1a; }
        .tab { flex: 1; padding: 15px; text-align: center; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid #8e44ad; color: #8e44ad; }
        .content { padding: 20px; display: none; flex-direction: column; align-items: center; }
        .content.active { display: flex; }

        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #222; color: white; box-sizing: border-box; }
        .rate-info { font-size: 0.9em; color: #aaa; margin: 10px 0; }
        .red { color: #ff4d4d; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="bal" style="color: gold;">‚≠ê <span id="s_bal">0</span></div>
        <div class="bal" style="color: #0088cc;">üíé <span id="t_bal">0.00</span></div>
        <button onclick="openM()" style="background:none; border:1px solid #8e44ad; color:white; border-radius:5px;">–ö–æ—à–µ–ª–µ–∫</button>
    </div>

    <div class="wheel-area">
        <div class="pointer"></div>
        <canvas id="canvas" width="600" height="600"></canvas>
    </div>

    <div class="bet-ctrl">
        <button class="btn-s" onclick="adjBet(-20)">-</button>
        <div style="text-align:center">–°—Ç–∞–≤–∫–∞<br><b id="cur_bet">5</b> ‚≠ê</div>
        <button class="btn-s" onclick="adjBet(20)">+</button>
    </div>

    <button id="spinBtn" class="spin-btn btn-active" onclick="handleSpin()">–ö–†–£–¢–ò–¢–¨</button>

    <div id="modal">
        <div class="tabs">
            <div class="tab active" onclick="setTab('dep')">–ü–û–ü–û–õ–ù–ò–¢–¨</div>
            <div class="tab" onclick="setTab('wit')">–í–´–í–û–î</div>
        </div>
        
        <div id="dep" class="content active">
            <h2 style="color: gold;">–°—É–º–º–∞ –∑–≤–µ–∑–¥</h2>
            <div class="bet-ctrl">
                <button class="btn-s" onclick="adjDep(-100)">-</button>
                <span id="dep_val" style="font-size: 2em;">100</span>
                <button class="btn-s" onclick="adjDep(100)">+</button>
            </div>
            <button class="spin-btn btn-active" onclick="doDep()">–ö–£–ü–ò–¢–¨ ‚≠ê</button>
            <p onclick="closeM()" style="margin-top:20px; color:#555;">–ó–∞–∫—Ä—ã—Ç—å</p>
        </div>

        <div id="wit" class="content">
            <h2>–í—ã–≤–æ–¥ TON</h2>
            <input type="number" id="w_stars" placeholder="–°—É–º–º–∞ –∑–≤–µ–∑–¥ (–º–∏–Ω. 500)" oninput="calcWit()">
            <input type="text" id="w_addr" placeholder="–ê–¥—Ä–µ—Å TON –∫–æ—à–µ–ª—å–∫–∞">
            <div class="rate-info">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: <b id="w_res">0.00</b> TON</div>
            <div id="w_err" class="red" style="display:none; margin-bottom:10px;">–ú–∏–Ω–∏–º—É–º 500 –∑–≤–µ–∑–¥!</div>
            <button id="witBtn" class="spin-btn btn-active" onclick="doWit()">–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–Ø–í–ö–£</button>
            <p onclick="closeM()" style="margin-top:20px; color:#555;">–ó–∞–∫—Ä—ã—Ç—å</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let stars = parseInt(new URLSearchParams(location.search).get('balance')) || 0;
        let ton = parseFloat(new URLSearchParams(location.search).get('ton')) || 0;
        let curBet = 5, depVal = 100, isSpinning = false, tonRate = 0.002; // –ü—Ä–∏–º–µ—Ä –∫—É—Ä—Å–∞: 1 –∑–≤–µ–∑–¥–∞ = 0.002 TON

        function update() {
            document.getElementById('s_bal').innerText = stars;
            document.getElementById('t_bal').innerText = ton.toFixed(2);
            document.getElementById('cur_bet').innerText = curBet;
            document.getElementById('dep_val').innerText = depVal;
            
            let sb = document.getElementById('spinBtn');
            if(stars < curBet) { sb.classList.add('btn-error'); } 
            else { sb.classList.remove('btn-error'); }
        }

        function adjBet(v) { if(!isSpinning) { curBet = Math.max(5, curBet + v); update(); } }
        function adjDep(v) { depVal = Math.max(100, depVal + v); update(); }
        
        function openM() { document.getElementById('modal').style.display = 'flex'; }
        function closeM() { document.getElementById('modal').style.display = 'none'; }
        function setTab(t) {
            document.querySelectorAll('.tab, .content').forEach(el => el.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            event.target.classList.add('active');
        }

        function calcWit() {
            let s = parseInt(document.getElementById('w_stars').value) || 0;
            document.getElementById('w_res').innerText = (s * tonRate).toFixed(3);
            document.getElementById('w_err').style.display = (s < 500 && s > 0) ? 'block' : 'none';
        }

        function handleSpin() {
            if(stars < curBet) { openM(); setTab('dep'); return; }
            if(!isSpinning) startSpin();
        }

        // ... –∫–æ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞–Ω–≤–∞—Å–∞ (draw) –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ –∫–∞–∫ –±—ã–ª ...
        // –ü–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä—É–ª–µ—Ç–∫–∏: 
        // tg.sendData(JSON.stringify({action: "spin", stars: stars, ton: ton}));

        function doDep() { tg.sendData(JSON.stringify({action: "deposit", amount: depVal})); }
        function doWit() {
            let s = parseInt(document.getElementById('w_stars').value);
            let a = document.getElementById('w_addr').value;
            if(s >= 500 && a.length > 10) {
                tg.sendData(JSON.stringify({action: "withdraw", amount: s, address: a}));
                tg.close();
            }
        }
        update();
    </script>
</body>
</html>
