<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Magik Spin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            min-height: 100vh; margin: 0; padding: 0;
            background: #050505; color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            /* Do NOT use overflow:hidden ‚Äî modal needs scrolling */
            overflow-x: hidden;
        }

```
    /* ‚îÄ‚îÄ MAIN SCREEN ‚îÄ‚îÄ */
    #main-screen {
        width: 100%; display: flex; flex-direction: column;
        align-items: center; justify-content: space-between;
        min-height: 100vh;
        padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
    .top-bar {
        width: 100%; padding: 10px 0;
        display: flex; justify-content: center; position: relative;
    }
    .bal-display {
        font-size: 2.2em; font-weight: bold; color: gold;
        text-shadow: 0 0 15px rgba(255,215,0,0.6);
    }
    .wallet-btn {
        position: absolute; right: 15px; top: 15px;
        background: rgba(142,68,173,0.3); border: 1px solid #8e44ad;
        color: white; border-radius: 8px; padding: 6px 12px; font-size: 0.8em;
        cursor: pointer;
    }

    /* ‚îÄ‚îÄ SUPERBONUS BANNER (only on main screen) ‚îÄ‚îÄ */
    #sb-banner {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 8px);
        left: 10px;
        z-index: 50; /* lower than modal z-index=100 */
        background: linear-gradient(135deg, #1a0f00 0%, #2d1a00 60%, #1a0f00 100%);
        border: 1.5px solid #ffd700;
        border-radius: 10px;
        padding: 5px 12px 5px 8px;
        display: flex; align-items: center; gap: 6px;
        box-shadow: 0 0 8px #ffd700, 0 0 20px #ffaa00, 0 0 35px rgba(255,136,0,0.4);
        animation: sbPulse 2.2s ease-in-out infinite;
        pointer-events: none;
    }
    @keyframes sbPulse {
        0%,100% { box-shadow: 0 0 8px #ffd700, 0 0 20px #ffaa00, 0 0 35px rgba(255,136,0,0.4); }
        50%      { box-shadow: 0 0 16px #ffd700, 0 0 36px #ffaa00, 0 0 65px rgba(255,136,0,0.7); }
    }
    #sb-banner .sb-crown  { font-size: 20px; filter: drop-shadow(0 0 6px #ffd700); }
    #sb-banner .sb-text   { display: flex; flex-direction: column; line-height: 1.2; }
    #sb-banner .sb-label  { font-size: 8px; font-weight: 900; letter-spacing: 2px; color: #ffd700; text-transform: uppercase; }
    #sb-banner .sb-amount { font-size: 14px; font-weight: 900; color: #fff; text-shadow: 0 0 8px #ffd700, 0 0 18px #ffaa00; }

    /* ‚îÄ‚îÄ WHEEL ‚îÄ‚îÄ */
    .wheel-container {
        position: relative; width: 80vw; max-width: 310px; aspect-ratio: 1/1;
    }
    canvas { width: 100%; height: 100%; filter: drop-shadow(0 0 15px #8e44ad); }

    /* Animated pointer */
    .pointer {
        position: absolute; top: -10px; left: 50%;
        transform: translateX(-50%);
        width: 0; height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-top: 25px solid #f1c40f;
        z-index: 10;
        filter: drop-shadow(0 0 8px rgba(241,196,15,0.8));
        transition: top 0.05s;
    }

    /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
    .controls { width: 100%; text-align: center; padding-bottom: 10px; }
    .bet-row {
        display: flex; align-items: center; justify-content: center;
        gap: 12px; margin-bottom: 12px;
    }
    .btn-adj {
        background: #8e44ad; border: none; color: white;
        width: 50px; height: 50px; border-radius: 50%; font-size: 1.5em;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }
    /* Sound button ‚Äî left of bet */
    #sound-btn {
        background: rgba(142,68,173,0.3);
        border: 1px solid #8e44ad;
        color: white; border-radius: 50%;
        width: 44px; height: 44px;
        font-size: 20px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: background 0.2s;
        flex-shrink: 0;
    }
    #sound-btn:hover { background: rgba(142,68,173,0.6); }

    .spin-btn {
        width: 85%; padding: 18px; border-radius: 50px; border: none;
        color: white; font-weight: bold; font-size: 1.4em;
        background: #8e44ad; box-shadow: 0 0 25px #8e44ad;
        transition: all 0.3s; cursor: pointer;
    }
    .dep-mode  { background: #e74c3c !important; box-shadow: 0 0 25px #e74c3c !important; }
    .free-mode { background: #27ae60 !important; box-shadow: 0 0 25px #27ae60 !important; }

    /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
    #history-bar {
        width: 90%; max-width: 310px;
        display: flex; gap: 6px; overflow-x: auto;
        padding: 4px 0 6px; scrollbar-width: none; margin-bottom: 4px;
    }
    #history-bar::-webkit-scrollbar { display: none; }
    .h-chip {
        flex-shrink: 0; border-radius: 20px; padding: 4px 10px;
        font-size: 0.75em; font-weight: bold; white-space: nowrap;
        opacity: 0; transform: scale(0.5);
        animation: chipIn 0.3s forwards;
    }
    @keyframes chipIn { to { opacity: 1; transform: scale(1); } }
    .h-win  { background: rgba(39,174,96,0.25);  border: 1px solid #27ae60; color: #2ecc71; }
    .h-lose { background: rgba(231,76,60,0.25);   border: 1px solid #e74c3c; color: #e74c3c; }
    .h-free { background: rgba(52,152,219,0.25);  border: 1px solid #3498db; color: #74b9ff; }

    /* ‚îÄ‚îÄ MODAL (wallet) ‚îÄ‚îÄ */
    #modal {
        display: none;
        position: fixed; inset: 0;
        background: #000;
        z-index: 100;
        flex-direction: column;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    #modal.open { display: flex; }
    .tabs { display: flex; background: #1a1a1a; flex-shrink: 0; }
    .tab { flex: 1; padding: 20px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { border-bottom: 3px solid #8e44ad; color: #8e44ad; }

    .tab-content {
        display: none; padding: 24px 20px 60px;
        flex-direction: column; align-items: center;
        width: 100%;
    }
    .tab-content.active { display: flex; }

    /* Input style */
    .modal-input {
        width: 100%; padding: 15px; margin: 10px 0;
        border-radius: 12px; border: 1px solid #444;
        background: #111; color: white; font-size: 1.1em;
    }
    .modal-input:focus { outline: none; border-color: #8e44ad; }

    .hint-text { color: #777; font-size: 0.82em; text-align: center; margin-top: 6px; line-height: 1.4; }
    .min-warn  { color: #e74c3c; font-size: 0.88em; text-align: center; margin: 8px 0 0; }
    .preview-ton { color: #0088cc; font-size: 1.05em; font-weight: bold; margin: 10px 0 6px; }

    .modal-btn {
        width: 100%; padding: 18px; border-radius: 50px; border: none;
        color: white; font-weight: bold; font-size: 1.3em;
        background: #8e44ad; box-shadow: 0 0 20px #8e44ad;
        margin-top: 14px; cursor: pointer;
    }
    .modal-btn.green { background: #27ae60; box-shadow: 0 0 20px #27ae60; }
    .back-link { margin-top: 24px; color: #777; font-size: 0.95em; cursor: pointer; }
</style>
```

</head>
<body>

```
<!-- SuperBonus Banner (fixed, z-index < modal) -->
<div id="sb-banner">
    <span class="sb-crown">üëë</span>
    <div class="sb-text">
        <span class="sb-label">SuperBonus</span>
        <span class="sb-amount">500 TON</span>
    </div>
</div>

<!-- Main Screen -->
<div id="main-screen">
    <div class="top-bar">
        <div class="bal-display">‚≠ê <span id="s_bal">0</span></div>
        <button class="wallet-btn" onclick="openM()">–ö–æ—à–µ–ª–µ–∫</button>
    </div>

    <div class="wheel-container">
        <div class="pointer" id="pointer"></div>
        <canvas id="canvas" width="600" height="600"></canvas>
    </div>

    <div id="history-bar"></div>

    <div class="controls">
        <div class="bet-row">
            <button id="sound-btn" onclick="toggleSound()">üîä</button>
            <button class="btn-adj" onclick="adjBet(-5)">-</button>
            <div>–°—Ç–∞–≤–∫–∞<br><b id="cur_bet">5</b> ‚≠ê</div>
            <button class="btn-adj" onclick="adjBet(5)">+</button>
        </div>
        <button id="spinBtn" class="spin-btn" onclick="handleSpin()">–ö–†–£–¢–ò–¢–¨</button>
    </div>
</div>

<!-- Modal Wallet -->
<div id="modal">
    <div class="tabs">
        <div class="tab active" id="tab-dep" onclick="setTab('dep',this)">–ü–û–ü–û–õ–ù–ò–¢–¨</div>
        <div class="tab"        id="tab-wit" onclick="setTab('wit',this)">–í–´–í–û–î</div>
    </div>

    <!-- DEPOSIT -->
    <div id="dep" class="tab-content active">
        <h2 style="color:gold; margin-bottom:6px;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚≠ê</h2>
        <p class="min-warn">–ú–∏–Ω–∏–º—É–º 10 ‚≠ê</p>
        <input  class="modal-input" type="number" id="dep_val"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∑–≤—ë–∑–¥"
                min="10" inputmode="numeric"
                oninput="validateDep()">
        <p class="hint-text">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞.</p>
        <button class="modal-btn green" onclick="doDep()">–ö–£–ü–ò–¢–¨ ‚≠ê</button>
        <p class="back-link" onclick="closeM()">‚Üê –ù–∞–∑–∞–¥</p>
    </div>

    <!-- WITHDRAW -->
    <div id="wit" class="tab-content">
        <h2 style="color:#0088cc; margin-bottom:6px;">–í—ã–≤–æ–¥ TON</h2>
        <p class="min-warn">–ú–∏–Ω–∏–º—É–º 500 ‚≠ê</p>

        <input class="modal-input" type="number" id="w_stars"
               placeholder="–°—É–º–º–∞ –∑–≤—ë–∑–¥ (–º–∏–Ω. 500)"
               inputmode="numeric" oninput="calcWit()">

        <div class="preview-ton" id="wit_preview">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚Äî TON</div>
        <p class="hint-text" id="rate-label">–ö—É—Ä—Å: –∑–∞–≥—Ä—É–∑–∫–∞...</p>

        <input class="modal-input" type="text" id="w_addr"
               placeholder="–ê–¥—Ä–µ—Å TON (UQ...)">

        <input class="modal-input" type="text" id="w_memo"
               placeholder="MEMO (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)">
        <p class="hint-text">MEMO ‚Äî –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–∏—Ä–∂–µ–π –∏–ª–∏ –∫–æ—à–µ–ª—å–∫–æ–º.</p>

        <button class="modal-btn" onclick="doWit()">–í–´–í–ï–°–¢–ò</button>
        <p class="back-link" onclick="closeM()">‚Üê –ù–∞–∑–∞–¥</p>
    </div>
</div>
```

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram.WebApp;
tg.expand();

let stars = 0, curBet = 5, isSpinning = false;
let userId       = new URLSearchParams(location.search).get('uid') || 'unknown';
let hasFreeSpins = 0;
const MIN_WITHDRAW = 500;
const MIN_DEPOSIT  = 10;

// TON/Star rate ‚Äî fetched or default
let tonPerStar = 0.013333; // ~1 XTR = 0.013333 TON (Telegram standard)

// Try fetch real rate from CoinGecko via TON price
(async function fetchRate() {
    try {
        // stars ‚Üí USD: 1 star = $0.013 (Telegram pricing)
        // Get TON/USD
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd', {cache:'no-cache'});
        if (r.ok) {
            const d = await r.json();
            const tonUsd = d['the-open-network']?.usd;
            if (tonUsd && tonUsd > 0) {
                tonPerStar = 0.013 / tonUsd; // 0.013 USD per star
                document.getElementById('rate-label').textContent =
                    `–ö—É—Ä—Å: 1 ‚≠ê ‚âà ${tonPerStar.toFixed(5)} TON (TON = $${tonUsd.toFixed(2)})`;
                calcWit();
            }
        }
    } catch(e) {
        document.getElementById('rate-label').textContent =
            `–ö—É—Ä—Å: 1 ‚≠ê ‚âà ${tonPerStar.toFixed(5)} TON (–±–µ–∑ —É—á—ë—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏)`;
    }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let soundEnabled = true;
let bgLoopTimer  = null;
let bgGain       = null;
const audioCtx   = new (window.AudioContext || window.webkitAudioContext)();

function ensureAudio() {
    if (audioCtx.state === 'suspended') return audioCtx.resume();
    return Promise.resolve();
}

function startBgMusic() {
    if (!soundEnabled || bgLoopTimer) return;
    bgGain = audioCtx.createGain();
    bgGain.gain.value = 0.05;
    bgGain.connect(audioCtx.destination);

    const melody = [
        [523.25,0.0,0.35],[659.25,0.45,0.35],[783.99,0.9,0.35],
        [1046.5,1.35,0.55],[783.99,2.0,0.25],[659.25,2.35,0.25],
        [523.25,2.7,0.35],[493.88,3.15,0.35],[392.00,3.6,0.35],
        [523.25,4.0,0.4],[659.25,4.5,0.35],[783.99,4.95,0.35],
        [880.00,5.4,0.55],[783.99,6.05,0.25],[659.25,6.4,0.25],
        [523.25,6.75,0.9],
    ];
    const bass = [[130.81,0],[130.81,1.35],[98.00,2.7],[130.81,4.0],[130.81,5.4]];
    const LOOP = 8.0;

    function sched(t0) {
        if (!bgGain) return;
        melody.forEach(([f,t,d]) => {
            const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
            osc.connect(g); g.connect(bgGain);
            osc.type='triangle'; osc.frequency.value=f;
            const s=t0+t;
            g.gain.setValueAtTime(0,s);
            g.gain.linearRampToValueAtTime(0.65,s+0.03);
            g.gain.exponentialRampToValueAtTime(0.001,s+d);
            osc.start(s); osc.stop(s+d+0.05);
        });
        bass.forEach(([f,t]) => {
            const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
            osc.connect(g); g.connect(bgGain);
            osc.type='sine'; osc.frequency.value=f;
            const s=t0+t;
            g.gain.setValueAtTime(0,s); g.gain.linearRampToValueAtTime(0.45,s+0.05);
            g.gain.exponentialRampToValueAtTime(0.001,s+0.5);
            osc.start(s); osc.stop(s+0.6);
        });
    }

    let t = audioCtx.currentTime + 0.1;
    sched(t);
    bgLoopTimer = setInterval(() => {
        if (!soundEnabled) { stopBgMusic(); return; }
        t += LOOP;
        sched(t);
    }, (LOOP - 0.4) * 1000);
}

function stopBgMusic() {
    if (bgLoopTimer) { clearInterval(bgLoopTimer); bgLoopTimer = null; }
    if (bgGain) { bgGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3); bgGain = null; }
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
    if (soundEnabled) ensureAudio().then(startBgMusic);
    else              stopBgMusic();
}

function playTone(freq, type, dur, vol) {
    if (!soundEnabled) return;
    const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);
    osc.type=type; osc.frequency.value=freq;
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
    osc.start(); osc.stop(audioCtx.currentTime+dur);
}
function playWin()   { [523,659,783,1046].forEach((f,i) => setTimeout(()=>playTone(f,'triangle',0.3,0.3),i*80)); }
function playLose()  { [300,220,160].forEach((f,i) => setTimeout(()=>playTone(f,'sawtooth',0.2,0.2),i*100)); }
function playFree()  { [659,880,1108].forEach((f,i) => setTimeout(()=>playTone(f,'sine',0.25,0.25),i*90)); }
function playClick() {
    if (!soundEnabled) return;
    playTone(800,'square',0.05,0.1);
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

let ratchetTimer = null;
function startRatchet(ms) {
    stopRatchet();
    ratchetTimer = setInterval(() => {
        if (!soundEnabled || audioCtx.state==='suspended') return;
        const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        osc.type='square'; osc.frequency.value=900;
        g.gain.setValueAtTime(0.07, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.04);
        osc.start(); osc.stop(audioCtx.currentTime+0.04);
    }, ms);
}
function stopRatchet() { if (ratchetTimer) { clearInterval(ratchetTimer); ratchetTimer=null; } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPERBONUS_INDEX = 5;
const sectors = [
    {t:"üíÄ",    c:"#1a1a1a", mult:0,   weight:25,  isSB:false},
    {t:"√ó1",    c:"#555555", mult:1,   weight:20,  isSB:false},
    {t:"FREE",  c:"#27ae60", mult:0,   weight:15,  isSB:false},
    {t:"√ó2",    c:"#3498db", mult:2,   weight:18,  isSB:false},
    {t:"üíÄ",    c:"#1a1a1a", mult:0,   weight:10,  isSB:false},
    {t:"‚≠ê500", c:"#7a4800", mult:0,   weight:0,   isSB:true },
    {t:"√ó5",    c:"#9b59b6", mult:5,   weight:8,   isSB:false},
    {t:"√ó1",    c:"#555555", mult:1,   weight:10,  isSB:false},
    {t:"√ó10",   c:"#f39c12", mult:10,  weight:3,   isSB:false},
    {t:"FREE",  c:"#27ae60", mult:0,   weight:5,   isSB:false},
    {t:"√ó100",  c:"#e74c3c", mult:100, weight:0.5, isSB:false},
    {t:"üíÄ",    c:"#1a1a1a", mult:0,   weight:5,   isSB:false},
    {t:"√ó2",    c:"#3498db", mult:2,   weight:10,  isSB:false}
];

const N   = sectors.length;
const ARC = (Math.PI * 2) / N;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS & DRAW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas  = document.getElementById('canvas');
const ctx     = canvas.getContext('2d');
const ptrEl   = document.getElementById('pointer');
let currentAngle = 0;

let hlIdx = -1, hlPhase = 0, hlRemain = 0, hlRAF = null;

function draw(angle, hi, phase) {
    ctx.clearRect(0, 0, 600, 600);
    sectors.forEach((s, i) => {
        const a = i * ARC + angle;
        if (s.isSB) {
            const g = ctx.createRadialGradient(300,300,60,300,300,280);
            g.addColorStop(0,'#fff3a0'); g.addColorStop(0.3,'#ffd700');
            g.addColorStop(0.7,'#cc8800'); g.addColorStop(1,'#7a4800');
            ctx.beginPath(); ctx.fillStyle=g;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
            ctx.save();
            ctx.shadowColor='#ffd700'; ctx.shadowBlur=28;
            ctx.beginPath(); ctx.strokeStyle='#ffd700'; ctx.lineWidth=4;
            ctx.moveTo(300,300); ctx.arc(300,300,278,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();
            ctx.restore();
        } else {
            ctx.beginPath(); ctx.fillStyle=s.c;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
        }

        // Highlight
        if (i === hi && hlRemain > 0) {
            const pulse = 0.45 + 0.55 * Math.abs(Math.sin(phase * 0.009));
            ctx.save();
            const hg = ctx.createRadialGradient(300,300,80,300,300,280);
            hg.addColorStop(0, `rgba(255,255,180,${0.22*pulse})`);
            hg.addColorStop(0.6,`rgba(255,210,0,${0.4*pulse})`);
            hg.addColorStop(1, `rgba(255,160,0,0)`);
            ctx.beginPath(); ctx.fillStyle=hg;
            ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.fill();
            ctx.shadowColor=`rgba(255,220,50,${pulse})`; ctx.shadowBlur=32;
            ctx.beginPath();
            ctx.strokeStyle=`rgba(255,230,60,${0.95*pulse})`; ctx.lineWidth=9;
            ctx.moveTo(300,300); ctx.arc(300,300,274,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();
            ctx.restore();
        }

        // Divider
        ctx.beginPath(); ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.lineWidth=1;
        ctx.moveTo(300,300); ctx.arc(300,300,280,a,a+ARC); ctx.lineTo(300,300); ctx.stroke();

        // Text
        ctx.save(); ctx.translate(300,300); ctx.rotate(a+ARC/2);
        if (s.isSB) {
            ctx.shadowColor='#ffd700'; ctx.shadowBlur=16;
            ctx.fillStyle='#fff'; ctx.font='bold 16px Arial';
            ctx.fillText('SUPER',118,-10); ctx.fillText('BONUS',118,10);
            ctx.font='bold 13px Arial'; ctx.fillStyle='#ffe066';
            ctx.fillText('500 TON',116,28); ctx.shadowBlur=0;
        } else {
            ctx.fillStyle='white'; ctx.font='bold 30px Arial';
            ctx.fillText(s.t, 150, 10);
        }
        ctx.restore();
    });
}

function startHighlight(idx) {
    hlIdx = idx; hlRemain = 4000; hlPhase = 0;
    let last = null;
    function loop(now) {
        if (!last) last = now;
        const dt = now - last; last = now;
        hlRemain -= dt; hlPhase  += dt;
        draw(currentAngle, hlRemain > 0 ? hlIdx : -1, hlPhase);
        if (hlRemain > 0) hlRAF = requestAnimationFrame(loop);
        else { hlIdx = -1; draw(currentAngle, -1, 0); }
    }
    if (hlRAF) cancelAnimationFrame(hlRAF);
    hlRAF = requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RANDOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getWeightedRandom() {
    const avail = sectors.map((s,i)=>({...s,idx:i})).filter(s=>!s.isSB);
    const total = avail.reduce((sum,s)=>sum+s.weight,0);
    let r = Math.random() * total;
    for (const s of avail) { r -= s.weight; if (r <= 0) return s.idx; }
    return avail[0].idx;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BALANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadBalance() {
    const urlBal = parseInt(new URLSearchParams(location.search).get('balance'));
    if (tg.CloudStorage) {
        tg.CloudStorage.getItem(`balance_${userId}`, (err,val) => {
            const saved = (!err&&val) ? parseInt(val) : NaN;
            if (!isNaN(saved) && saved >= 0) {
                stars = (!isNaN(urlBal) && urlBal > saved) ? urlBal : saved;
            } else {
                stars = (!isNaN(urlBal) && urlBal >= 0) ? urlBal : 0;
            }
            if (!isNaN(urlBal) && urlBal > (isNaN(saved)?-1:saved)) saveBalance();
            update();
        });
    } else {
        stars = (!isNaN(urlBal) && urlBal >= 0) ? urlBal : 0;
        update();
    }
}

function saveBalance(cb) {
    if (tg.CloudStorage) {
        tg.CloudStorage.setItem(`balance_${userId}`, stars.toString(), err => {
            if (!err) console.log('üíæ', stars);
            if (cb) cb();
        });
    } else if (cb) cb();
}

function update() {
    document.getElementById('s_bal').innerText   = stars;
    document.getElementById('cur_bet').innerText = curBet;
    const btn = document.getElementById('spinBtn');
    if (hasFreeSpins > 0) {
        btn.innerText = `üéÅ FREE SPIN (${hasFreeSpins})`;
        btn.classList.remove('dep-mode'); btn.classList.add('free-mode');
    } else if (stars < curBet) {
        btn.innerText = "–ü–û–ü–û–õ–ù–ò–¢–¨";
        btn.classList.add('dep-mode'); btn.classList.remove('free-mode');
    } else {
        btn.innerText = "–ö–†–£–¢–ò–¢–¨";
        btn.classList.remove('dep-mode','free-mode');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const history = [];
function addHistory(label, cls) {
    history.unshift({label, cls});
    if (history.length > 12) history.pop();
    const bar = document.getElementById('history-bar');
    bar.innerHTML = '';
    history.forEach(item => {
        const c = document.createElement('div');
        c.className = `h-chip ${item.cls}`;
        c.textContent = item.label;
        bar.appendChild(c);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPIN
// Easing: ease-in-out (accelerate ‚Üí decelerate ‚Üí stop)
// With optional near-miss creep near SuperBonus
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function angleForSector(idx) {
    // Pointer at top = -œÄ/2
    // Sector i center at: i*ARC + ARC/2 + angle = -œÄ/2  ‚Üí  angle = -œÄ/2 - i*ARC - ARC/2
    return -Math.PI / 2 - idx * ARC - ARC / 2;
}

// Pointer bounce animation during spin
let ptrAnimFrame = null;
let ptrPhase = 0;
function animPointer(speed) {
    // speed: 0=stopped, 1=fast, between
    const bounce = speed * 8; // px bounce
    ptrPhase += speed * 0.3;
    const off = Math.abs(Math.sin(ptrPhase)) * bounce;
    ptrEl.style.top = (-10 - off) + 'px';
    if (speed > 0) ptrAnimFrame = requestAnimationFrame(() => animPointer(speed));
    else ptrEl.style.top = '-10px';
}
function stopPointerAnim() {
    if (ptrAnimFrame) { cancelAnimationFrame(ptrAnimFrame); ptrAnimFrame = null; }
    ptrEl.style.top = '-10px';
}

function handleSpin() {
    if (isSpinning) return;
    if (hasFreeSpins === 0 && stars < curBet) { openM(); return; }
    if (hlRAF) { cancelAnimationFrame(hlRAF); hlRAF = null; hlIdx = -1; }

    ensureAudio().then(() => {
        startBgMusic();
        doSpin();
    });
}

function doSpin() {
    playClick();
    isSpinning = true;

    let isFree = false;
    if (hasFreeSpins > 0) { hasFreeSpins--; isFree = true; }
    else                   { stars -= curBet; }
    update(); saveBalance();

    const realIdx  = getWeightedRandom();
    const nearMiss = Math.random() < 0.50;
    const finalIdx = nearMiss ? (SUPERBONUS_INDEX + 1) % N : realIdx;

    // Target angle
    const target = angleForSector(finalIdx);
    // Build finalAngle > currentAngle + 8 full rotations
    let finalAngle = target;
    const minAngle = currentAngle + Math.PI * 2 * 8;
    while (finalAngle < minAngle) finalAngle += Math.PI * 2;
    const totalRot = finalAngle - currentAngle;
    const startAng = currentAngle;

    // Duration: 5.5-7s
    const dur = nearMiss ? 7200 : 5000 + Math.random() * 1200;

    let t0 = null;
    let lastSpeed = 45;
    startRatchet(45);
    animPointer(1);

    function easeInOut(p) {
        // Standard smoothstep ease-in-out
        return p < 0.5 ? 4 * p * p * p : 1 - Math.pow(-2 * p + 2, 3) / 2;
    }

    function eased(p) {
        if (nearMiss) {
            if      (p < 0.68)  return easeInOut(p / 0.68) * 0.70;
            else if (p < 0.84)  { const q=(p-0.68)/0.16; return 0.70 + 0.03*(1-Math.pow(1-q,2)); }
            else                { const q=(p-0.84)/0.16; return 0.73 + 0.27*(1-Math.pow(1-q,3)); }
        }
        return easeInOut(p);
    }

    function frame(now) {
        if (!t0) t0 = now;
        const p  = Math.min((now - t0) / dur, 1);
        const e  = eased(p);

        currentAngle = startAng + totalRot * e;
        draw(currentAngle, -1, 0);

        // Pointer bounce based on speed (derivative of eased)
        const dp = Math.min((now - t0 + 16) / dur, 1);
        const velocity = Math.max(0, (eased(dp) - e) / 0.016);
        animPointer(Math.min(velocity * 40, 1));

        // Ratchet
        const spd = p > 0.85 ? 200 : p > 0.65 ? 100 : 45;
        if (spd !== lastSpeed) { lastSpeed = spd; startRatchet(spd); }

        if (p < 1) {
            requestAnimationFrame(frame);
        } else {
            stopRatchet(); stopPointerAnim();
            isSpinning = false;
            currentAngle = finalAngle; // exact

            const win = sectors[finalIdx];
            let winAmount = 0;

            if (win.t === 'FREE') {
                hasFreeSpins++;
                playFree();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                addHistory('üéÅ FREE', 'h-free');
            } else if (win.mult > 0) {
                winAmount = curBet * win.mult;
                stars += winAmount; // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç
                playWin();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                const lbl = isFree ? `üéÅ+${winAmount}‚≠ê` : `${win.t}+${winAmount}‚≠ê`;
                addHistory(lbl, 'h-win');
            } else {
                playLose();
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                addHistory(isFree ? 'üéÅüíÄ' : `-${curBet}‚≠ê`, 'h-lose');
            }

            startHighlight(finalIdx);
            saveBalance();
            update();
        }
    }
    requestAnimationFrame(frame);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openM() {
    playClick();
    document.getElementById('modal').classList.add('open');
}
function closeM() {
    playClick();
    document.getElementById('modal').classList.remove('open');
}
function setTab(t, el) {
    playClick();
    document.querySelectorAll('.tab,.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    el.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ DEPOSIT ‚îÄ‚îÄ‚îÄ
function validateDep() {
    const v = parseInt(document.getElementById('dep_val').value);
    // just let user type freely; validation on submit
}
function doDep() {
    playClick();
    const val = parseInt(document.getElementById('dep_val').value);
    if (!val || isNaN(val) || val < MIN_DEPOSIT) {
        tg.showAlert(`‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${MIN_DEPOSIT} ‚≠ê`);
        return;
    }
    tg.sendData(JSON.stringify({action:'deposit', amount:val, stars}));
}

// ‚îÄ‚îÄ‚îÄ WITHDRAW ‚îÄ‚îÄ‚îÄ
function calcWit() {
    const v = parseInt(document.getElementById('w_stars').value) || 0;
    const ton = (v * tonPerStar).toFixed(4);
    document.getElementById('wit_preview').textContent =
        v > 0 ? `–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚âà ${ton} TON` : '–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ‚Äî TON';
}
function doWit() {
    playClick();
    const val  = parseInt(document.getElementById('w_stars').value);
    const addr = document.getElementById('w_addr').value.trim();
    const memo = document.getElementById('w_memo').value.trim();
    if (!addr)                          { tg.showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å TON!'); return; }
    if (!val || isNaN(val) || val <= 0) { tg.showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É!'); return; }
    if (val < MIN_WITHDRAW)             { tg.showAlert(`‚ùå –ú–∏–Ω–∏–º—É–º ${MIN_WITHDRAW} ‚≠ê`); return; }
    if (val > stars)                    { tg.showAlert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê (—É –≤–∞—Å ${stars})`); return; }

    const ton = (val * tonPerStar).toFixed(4);
    tg.sendData(JSON.stringify({
        action:  'withdraw',
        amount:  val,
        ton:     ton,
        rate:    tonPerStar.toFixed(6),
        address: addr,
        memo:    memo || null,
        stars
    }));
}

// ‚îÄ‚îÄ‚îÄ BET ‚îÄ‚îÄ‚îÄ
function adjBet(v) { playClick(); curBet = Math.max(5, curBet + v); update(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('beforeunload', () => saveBalance());
window.addEventListener('DOMContentLoaded', () => {
    loadBalance();
    draw(0, -1, 0);
    // Show initial rate label
    document.getElementById('rate-label').textContent =
        `–ö—É—Ä—Å: 1 ‚≠ê ‚âà ${tonPerStar.toFixed(5)} TON (–±–µ–∑ —É—á—ë—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏)`;
});
</script>

</body>
</html>